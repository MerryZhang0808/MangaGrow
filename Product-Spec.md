# Product Spec - 漫画成长记录

## 产品说明

这是一个帮助家长将孩子成长瞬间转化为漫画故事的 AI 应用。家长经常因为来不及拿手机而错过记录孩子的成长瞬间，或者拍了很多照片视频却不知道如何整理。本产品支持家长通过文字描述、语音记录、照片上传等多种方式输入故事，AI 自动生成漫画分镜脚本和配图，生成温馨可爱的漫画故事，既保护隐私（不用发社交平台），又方便保存和分享。适用于家长记录孩子日常趣事、成长里程碑、家庭温馨时刻。

## 功能需求

**第一期核心功能：**
- 多种输入方式：支持文字输入、语音录制（按住说话）、照片上传，可混合输入
- 智能分镜拆分：AI 自动将故事拆分为 2-4 个分镜，超过 4 个则分批生成
- 分镜内容生成：AI 为每个分镜同时生成两份文字——①「故事叙述（caption）」10-20字，展示在漫画图下方，语言温馨生动；②「图像脚本（script）」50-100字，用于 AI 图像生成，含完整视觉细节
- 漫画图片生成：根据 script 生成对应的漫画图片，支持 4 种风格（温馨卡通、柔和水彩、简约扁平、手绘涂鸦）
- 脚本编辑与重新生成：鼠标悬停分镜卡片，点击右上角「编辑」图标，以气泡弹窗方式展示完整 script 并支持修改，修改后点击「保存并重绘」单独重新生成该分镜图片
- 人物库管理：创建人物（名字+照片→AI识别性别/年龄→生成卡通形象→可重新生成），AI 根据输入文本中出现的人物名字自动匹配人物库，仅展示故事中提及的人物
- 导出功能：支持 PNG/JPG 格式导出漫画图片，可单张或打包下载；支持网格海报式导出（所有分镜拼合为一张完整海报图）
- 故事标题：AI 根据故事内容自动生成简短标题，格式为「{人名}+{核心事件}」的名词短语（如"念念第一次吃饭"、"雨天的纸船"），4-10字，与故事主题强相关；故事管线完成后立即返回标题，在图片开始生成前就显示在界面上；用户可修改
- 手动保存确认：生成完成后，底部浮动操作栏出现「保存故事」按钮，用户点击后自动生成海报并将故事存入历史记录（保存内容：海报图 + 原始输入文字 + 原始上传照片 + 故事标题）；未点击则不保存（避免废片堆积）；已保存的故事为只读，不可再编辑
- 历史记录浏览：左侧导航栏新增历史图标，点击打开历史侧边栏；点击某条记录展开查看：海报图（大图）+ 原始输入文字 + 原始上传照片；历史记录为只读，不支持重绘或编辑
- 成长相册：左侧导航栏新增成长相册图标，点击打开成长相册主页面；以时间轴布局纵向滚动展示所有已保存故事，按年/月分组，每条记录显示日期 + 海报缩略图 + 故事标题
- PDF 成长故事书：在成长相册页面，用户选择日期范围（月/半年/一年/自定义），生成 PDF 文件，内容包含：①封面（孩子名字 + 日期范围）②所选故事的海报页（每故事一页，含标题 + 日期 + 海报图）③AI 生成的阶段总结（基于该时段所有故事标题和原始输入，生成温馨叙述）
- 后端持久化：Node.js/Express 轻量后端，SQLite 存储人物库和漫画历史，图片存本地磁盘，API Key 藏在服务端

**第二期规划（暂不实现）：**
- 漫画变视频（添加动画效果和配音）
- 人物一致性增强（接入第三方工具实现真正的人物形象一致）
- 声音克隆（为人物配上孩子真实的声音）
- 用户登录与认证系统（后端已预留 user_id 字段，需增加登录、注册、会话管理）
- 云端部署与数据同步（将本地 SQLite 迁移到云数据库，图片迁移到对象存储）
- 分享功能

## UI 布局

### 整体布局
**桌面端**：左侧导航栏（固定宽度） + 中间输入区（400px） + 右侧展示区（flex）
- 左侧：导航栏（窄栏，仅图标）
- 中间：输入区（包含输入模块、人物快捷区、设置折叠区）
- 右侧：分镜展示区
- 额外：左侧可折叠侧边栏（人物库，覆盖在导航栏和输入区上方）

**移动端**：单栏垂直布局，从上到下依次是：输入区 → 展示区（设置折叠在输入区内）

---

### 左侧 - 导航栏（固定宽度 64px）

**顶部**：
- 产品图标（漫画成长记录 Logo）

**中部功能图标**（纵向排列）：
- 人物库图标：点击打开左侧折叠侧边栏（人物库）
- 历史记录图标：点击打开历史记录主页面（双栏布局，与成长相册图标行为一致）
- 成长相册图标：点击打开成长相册主页面（时间轴 + PDF 生成）
- 新创作图标：点击清空当前内容，开始新创作

**底部**：
- 设置/个人头像占位图标

---

### 中间 - 输入区（400px）

**顶部标题**：
- 标题：「新的回忆」（生成后由 AI 自动替换为故事标题，如「念念第一次吃饭」，可点击编辑）
- 日期：当前日期（如「2026年2月14日 星期五」）

**输入模块**：
- **文字输入框**：
  - 多行文本框，占满宽度，最小高度 200px
  - Placeholder：「念念抽屉里翻出一个头发夹子...」
  - 右下角浮动麦克风按钮（语音输入）

- **语音按钮**：
  - 位置：文字输入框右下角浮动
  - 样式：麦克风图标，录音时红色+脉动动画
  - 交互：按住说话（松开自动转文字并显示在输入框）

- **照片上传区**：
  - 位置：文字输入框下方
  - 标题：「参考照片」（Reference Photo）
  - 已上传照片显示为缩略图卡片（80x80px），可删除
  - 「添加照片」按钮（Add Photo）

**人物快捷区**（可选展示）：
- 标题：「谁在这个故事里？」（Who is in this story?）
- 根据输入文本中出现的人物名字自动匹配人物库，仅显示故事中提及的人物头像+名字；未输入文字或文本中无人物名字时不显示任何人物
- 点击人物头像：打开人物库侧边栏并直接进入该人物详情页
- 「添加」按钮（+图标），点击打开人物库侧边栏

**设置区（可折叠）**：
- **折叠触发**：底部操作栏左侧的「设置」图标按钮
- **展开内容**：
  - **漫画风格选择**：
    - 标题：「风格」（Style）
    - 控件：横向按钮组（多选一）
    - 选项：温馨卡通（默认）、柔和水彩、简约扁平、手绘涂鸦
  - **图片比例选择**：
    - 标题：「比例」（Ratio）
    - 控件：横向按钮组（多选一）
    - 选项：4:3（默认）、16:9、1:1、9:16

**底部操作栏**（固定在输入区底部）：
- 左侧：「设置」图标按钮（点击展开/收起设置区）
- 右侧：「生成漫画」按钮（Generate Comic，主按钮，占满剩余宽度）

---

### 右侧 - 分镜展示区（flex-1）

**初始状态**：
- 显示欢迎提示：「等待你的故事...」（Waiting for your story...）
- 空状态图标（虚线边框方框+图片占位符）

**生成中状态**：
- 显示加载动画（每个分镜卡片内）
- 流式显示分镜卡片（每生成一个分镜就显示一个）

**分镜卡片布局**（每个分镜一个卡片，网格布局，上下滚动）：
- **整体样式**：漫画边框风格（黑色粗边框 + 阴影）
- **卡片编号**：左上角黑底白字数字标签（1、2、3...）
- **纵向布局**：
  - **上方（主体）**：漫画图片区
    - 漫画图片（大图展示，宽高比 4:3）
    - 鼠标悬停显示操作按钮（右上角）：
      - 「重绘」按钮（Redraw，刷新图标）
      - 「编辑脚本」按钮（Edit Script，编辑图标），点击后以气泡弹窗方式展示完整 script（50-100字），支持修改后「保存并重绘」或「取消」
  - **下方**：故事叙述区（caption）
    - 显示 10-20字 温馨简短的故事叙述文字（居中显示）
    - caption 是供读者阅读的配文，非 AI 图像生成脚本；script 仅在编辑弹窗中展示

**顶部信息栏**（生成完成后显示）：
- 故事标题（AI 自动生成，可点击编辑）
- 创建时间
- 保存状态指示：生成完成未保存时显示「未保存」，点击「保存故事」后显示「✅ 已保存」

**底部浮动操作栏**（固定在右下角）：
- 「重绘全部」按钮（Redraw All，次要按钮）
- 「保存故事」按钮（Save Story，**仅在生成完成且尚未保存时显示**，点击保存入历史记录；保存成功后按钮消失）
- 「导出」下拉按钮（Export，主按钮），点击展开选项：
  - 「导出海报」（Export Poster）：生成网格海报 PNG 图片
  - 「导出 ZIP」（Export ZIP）：所有分镜图片 + 脚本打包下载（原有功能）

---

### 左侧折叠侧边栏 - 人物库（覆盖在输入区上方）

**顶部**：
- 标题「人物库」
- 关闭按钮（右上角 X）

**人物列表**：
- 显示已创建的人物卡片（垂直滚动）
- 每张卡片包含：
  - 人物名字
  - 卡通形象缩略图（圆形，56x56px）
  - 性别和年龄标识（文字标签）
  - 创建时间
  - 点击卡片进入详情页

**底部**：
- 「创建新人物」按钮（主按钮，醒目样式）

**创建人物流程**（侧边栏内切换视图）：
1. 输入人物名字（必填）
2. 上传照片（单张，必填）
3. 点击「生成」按钮
4. AI 生成卡通形象（1:1方形，2K分辨率）
5. AI 自动识别性别和年龄段（1-3秒）
6. 显示生成的卡通形象 + 性别/年龄标识
7. 人物自动保存到人物库列表
8. 点击卡片可进入详情页修改

**人物详情页**（侧边栏内切换视图）：
- 返回按钮（左上角）
- 卡通形象大图（方形显示）
  - 右上角悬停显示刷新按钮（与漫画图重新生成样式一致）
- 性别字段：
  - 下拉框：男 / 女 / 未知
  - 默认值为 AI 识别结果
- 年龄段字段：
  - 下拉框：婴儿(0-1岁) / 幼儿(1-3岁) / 儿童(3-6岁) / 少儿(6-12岁) / 成人 / 未知
  - 默认值为 AI 识别结果
- 具体年龄字段：
  - 文本框（可选）：用户填写具体年龄（如"1.5岁"）
  - 为空则使用年龄段
- 保存按钮（底部）
- 删除人物按钮（底部，次要样式）

**交互规则**：
- 用户修改性别/年龄后，点击图片右上角刷新按钮手动重新生成头像
- 重新生成时，AI 会参考照片 + 用户选择的性别 + 年龄段/具体年龄
- 点击保存后，更新的性别/年龄信息会写入 character.description，用于后续漫画生成时保持年龄一致性

---

### 历史记录主页面（点击左侧历史记录图标后打开，占据主内容区）

**页面结构**（替换中间输入区 + 右侧展示区，左右双栏布局）：

```
┌──────────────────────────────────────────────────────────────┐
│  历史记录                                              [关闭 ×] │ ← 顶部栏
├─────────────────────┬────────────────────────────────────────┤
│  故事列表（左栏）     │  故事详情（右栏）                         │
│  固定宽度 280px      │  flex 占满剩余宽度                        │
│  垂直滚动           │                                          │
│                     │  ┌────────────────────────────────────┐ │
│  ┌───────────────┐  │  │  念念第一次自己吃饭                  │ │ ← 标题
│  │ [海报缩略图]   │  │  │  2026年2月14日                      │ │ ← 日期
│  │ 念念第一次吃饭 │◀─┤  │                                    │ │
│  │ 2026.02.14   │  │  │  [海报大图，全宽展示]                 │ │
│  └───────────────┘  │  │                                    │ │
│  ┌───────────────┐  │  │  ─── 原始故事输入 ───               │ │
│  │ [海报缩略图]   │  │  │  念念今天第一次自己拿勺子吃饭...       │ │
│  │ 公园里的纸船   │  │  │                                    │ │
│  │ 2026.02.10   │  │  │  ─── 参考照片 ───                   │ │
│  └───────────────┘  │  │  [照片1] [照片2]                   │ │
│                     │  └────────────────────────────────────┘ │
└─────────────────────┴────────────────────────────────────────┘
```

**左栏 - 故事列表**：
- 按时间倒序显示所有已保存的漫画故事（垂直滚动）
- 每条卡片包含：海报缩略图（80x60px）+ 故事标题 + 创建日期
- 点击卡片 → 右栏立即更新为该故事详情，无需翻页
- 当前选中卡片高亮显示（左侧彩色边框）
- 默认选中最新一条

**右栏 - 故事详情（只读）**：
- 故事标题 + 创建日期（顶部）
- 海报大图（全宽展示）
- 原始故事输入文字（用户当时写/说的故事描述）
- 参考照片（若有，小图横排）
- 右上角「删除」图标：确认弹窗后删除该故事（含海报图和原始照片）

**空状态**（无任何历史）：
- 「还没有创作记录，开始你的第一个故事吧！」（居中显示）

**右栏空状态**（有故事列表但未选中）：
- 「← 选择左侧故事查看详情」

---

### 成长相册主页面（点击左侧成长相册图标后打开，占据主内容区）

**页面结构**（替换中间输入区 + 右侧展示区，全宽显示）：

```
┌──────────────────────────────────────────────────────┐
│  成长相册                          [生成 PDF 故事书 ▾] │ ← 顶部栏
├──────────────────────────────────────────────────────┤
│  2026 年                                              │ ← 年份分组线
│  ┌───────────────────────────────────────────────┐   │
│  │  2026年2月14日  [封面图 80x60]  念念第一次吃饭  │   │ ← 故事条目
│  └───────────────────────────────────────────────┘   │
│  ┌───────────────────────────────────────────────┐   │
│  │  2026年2月10日  [封面图 80x60]  公园里的纸船   │   │
│  └───────────────────────────────────────────────┘   │
│  2025 年                                              │
│  ┌───────────────────────────────────────────────┐   │
│  │  2025年12月25日 [封面图 80x60]  圣诞节快乐     │   │
│  └───────────────────────────────────────────────┘   │
└──────────────────────────────────────────────────────┘
```

**顶部栏**：
- 左侧：标题「成长相册」
- 右侧：「生成 PDF 故事书」下拉按钮，点击展开日期范围选择面板

**时间轴列表**（纵向滚动，按年/月分组）：
- 年份分组标题行（如「2026 年」）：灰色小字，带分隔线
- 月份分组（可选，当同一年内故事较多时显示，如「2月」）
- 每条故事卡片包含：
  - 创建日期（如「2026年2月14日」）
  - 海报缩略图（圆角矩形，80x60px）
  - 故事标题
  - 点击卡片 → 在成长相册内展开只读详情（海报大图 + 原始输入文字 + 原始照片）

**空状态**：
- 「还没有保存的故事，去创作第一个吧！」

---

### PDF 故事书生成面板（浮层，点击「生成 PDF 故事书」按钮后展开）

**日期范围选择**：
- 预设选项（横向按钮组，单选）：「最近一个月」「最近半年」「最近一年」「自定义」
- 选择「自定义」时显示：开始日期输入框 + 结束日期输入框
- 选中范围后实时显示「已选 X 个故事」提示

**预览信息**：
- 列出将被包含的故事标题列表（最多显示5条，超出显示"+N个"）

**操作按钮**：
- 「生成 PDF」主按钮（生成中显示进度提示）
- 「取消」次要按钮

**PDF 文件结构**：
```
封面页：
  - 孩子名字（从人物库获取最常出现的人物名，若无则为"我的成长故事"）
  - 日期范围（如「2025年7月 - 2026年2月」）
  - MangaGrow 品牌标识

故事海报页（每个故事 1 页）：
  - 故事标题 + 创建日期
  - 海报图（全页展示）

AI 阶段总结页（放在所有故事之后）：
  - 标题：「${时间段}的成长轨迹」
  - AI 生成的总结文字（300-500字，温馨叙述，基于该时段所有故事标题和原始输入文字生成）
```

---

### 网格海报导出规格

**海报结构**：
```
┌─────────────────────────────┐
│    故事标题                    │ ← AI 生成的标题
│    创建日期                    │
├──────────────┬──────────────┤
│   分镜 1      │   分镜 2      │
│   [图片]      │   [图片]      │
│  "故事叙述"   │  "故事叙述"   │
├──────────────┼──────────────┤
│   分镜 3      │   分镜 4      │
│   [图片]      │   [图片]      │
│  "故事叙述"   │  "故事叙述"   │
├──────────────┴──────────────┤
│         MangaGrow            │ ← 底部水印
└─────────────────────────────┘
```

**视觉规格**：
- 背景色：白色（#FFFFFF）
- 标题区：居中，标题字号较大，日期字号较小灰色
- 分镜区：固定 2 列，图片上方 + 脚本文字下方，分镜间留白间距
- 水印区：底部居中，「MangaGrow」灰色小字
- 输出格式：PNG
- 输出分辨率：根据分镜图片尺寸自动计算，确保清晰

**分镜数量自适应排版**（固定 2 列，奇数末行居中）：

| 分镜数 | 行数 | 排法 |
|-------|------|------|
| 2 | 1 行 | 2 列 |
| 3 | 2 行 | 2 + 1（末行居中）|
| 4 | 2 行 | 2 × 2 |
| 5 | 3 行 | 2 + 2 + 1 |
| 6 | 3 行 | 2 × 3 |
| 7 | 4 行 | 2 + 2 + 2 + 1 |
| 8 | 4 行 | 2 × 4 |

---

## 用户使用流程

### 快速上手流程（首次使用）

1. 打开应用，看到欢迎界面和初始提示
2. 在中间输入区输入文字描述或按住录音讲述故事，或上传照片（可混合）
3. 如需调整风格或比例，点击底部「设置」按钮展开设置区，选择漫画风格和图片比例（或使用默认）
4. 点击「生成漫画」按钮
5. AI 分析输入，生成分镜脚本
6. 分镜脚本生成完成后，立即在右侧面板顶部显示 AI 生成的故事标题和日期（早于图片生成完成）
7. 右侧流式显示分镜卡片（图片逐张加载中）
8. 全部图片生成完成后：
   - 底部出现「保存故事」按钮；顶部信息栏显示「未保存」状态
   - 可以（保存前的当前创作中）：
     - 鼠标悬停在分镜卡片上，点击「重绘」按钮重新生成该分镜
     - 点击「编辑脚本」按钮修改脚本，然后「保存并重绘」
     - 如果有后续分镜，点击「继续生成后续」
9. 满意后点击「保存故事」按钮：自动合成海报图 → 保存（标题 + 海报图 + 原始输入文字 + 原始上传照片）→ 存入历史记录和成长相册；保存后不可再编辑
10. 点击右下角「导出」按钮，选择「导出海报」或「导出 ZIP」

---

### 使用人物库流程

**创建人物**：
1. 点击左侧导航栏「人物库」图标，打开侧边栏
2. 点击「新建人物」（New Character）按钮
3. 输入人物名字（如「念念」）
4. 上传孩子的照片（单张）
5. 点击「生成」（Generate）按钮
6. AI 生成卡通头像（1:1方形，2K分辨率，10-30秒）
7. AI 自动识别性别和年龄段（1-3秒）
8. 小卡片自动保存到人物库列表，显示头像 + 名字 + 性别/年龄标识

**查看和编辑人物**：
1. 点击人物库列表中的小卡片
2. 进入详情页，显示大图 + 性别/年龄字段
3. 可修改性别（下拉框：男/女/未知）
4. 可修改年龄段（下拉框：婴儿/幼儿/儿童/少儿/成人/未知）
5. 可填写具体年龄（文本框，如"1.5岁"）
6. 如不满意，点击图片右上角刷新按钮重新生成（传入照片 + 性别 + 年龄）
7. 点击保存，性别/年龄信息更新到 character.description（用于后续漫画生成时保持一致性）

**在故事中使用人物**：
1. 在输入框中提到人物名字（如「念念今天第一次自己吃饭」）
2. AI 自动识别「念念」，去人物库匹配
3. 生成漫画时，AI 参考「念念」的 character.description（包含性别、年龄、外貌特征）
4. 生成的漫画中会保持人物年龄一致（如头像是1.5岁，漫画也是1.5岁，不会变成3-4岁）

**典型使用场景**：
- 用户创建了1.5岁宝宝的人物，生成头像后发现漫画中宝宝看起来像3-4岁
- 用户进入详情页，确认年龄段为"幼儿(1-3岁)"，并填写具体年龄"1.5岁"
- 保存后，后续生成的漫画中，AI 会严格按照1.5岁幼儿的特征生成，保持一致性

---

### 成长相册浏览流程

1. 点击左侧导航栏「成长相册」图标，打开成长相册主页面（主内容区切换为成长相册视图）
2. 时间轴按年/月分组，从近到远纵向排列所有已保存故事
3. 每条记录显示：日期 + 海报缩略图 + 故事标题
4. 点击某条故事卡片 → 在成长相册内展开只读详情（海报大图 + 原始输入文字 + 原始上传照片）

---

### PDF 成长故事书生成流程

1. 在成长相册主页面，点击右上角「生成 PDF 故事书」按钮
2. 弹出日期范围选择面板：
   - 点击预设：「最近一个月」「最近半年」「最近一年」（默认）
   - 或点击「自定义」，填写开始/结束日期
3. 面板实时显示「已选 X 个故事」
4. 点击「生成 PDF」按钮
5. 系统处理中（显示进度提示）：
   - 调用 AI 生成阶段总结（基于所选故事的标题和原始输入文字）
   - 拼合 PDF（封面 + 各故事海报页 + AI 总结页）
6. PDF 生成完成后，浏览器自动下载（文件名：`成长故事书_${日期范围}.pdf`）

---

### 历史记录浏览流程

1. 点击左侧导航栏「历史记录」图标，打开历史记录主页面（全宽双栏布局，取代主内容区）
2. 左栏加载所有已保存故事列表（倒序），默认选中最新一条，右栏显示其详情
3. 点击左栏任意故事卡片 → 右栏即时切换为该故事的详情（无需返回、无需翻页）
4. 右栏展示内容（只读）：海报大图 + 原始输入文字 + 参考照片（若有）
5. 删除：点击右栏右上角「删除」图标 → 确认弹窗 → 删除后左栏自动选中下一条
6. 点击顶部「关闭 ×」或左侧导航栏图标 → 返回主创作界面

---

### 修改和重新生成流程

1. 生成完成后，查看右侧分镜展示区
2. 发现某个分镜不满意，鼠标悬停在该分镜卡片上
3. 点击「编辑脚本」（Edit Script）按钮
4. 修改脚本内容（如调整人物动作、场景描述）
5. 点击「保存并重绘」（Save & Redraw）按钮
6. AI 根据修改后的脚本重新生成该分镜的图片（其他分镜不变）
7. 查看新图片，满意后继续或点击「导出」

---

### 导出流程

1. 点击右下角浮动的「导出」（Export）下拉按钮
2. 选择导出方式：
   - **导出海报**：前端将所有分镜拼合为网格海报（标题 + 日期 + 分镜网格 + MangaGrow 水印），生成 PNG 图片下载（文件名：`故事标题_poster.png`）
   - **导出 ZIP**：所有分镜图片 + 脚本文本打包成 ZIP 文件下载（文件名：`comic_story_[时间戳].zip`）
3. 下载文件到本地

---

## 补充说明

### 漫画风格详细说明

| 风格 | 视觉特点 | 适用场景 |
|-----|---------|---------|
| 温馨卡通（默认） | 粗线条、明亮色彩、Q版人物、温暖氛围 | 日常趣事、温馨时刻 |
| 柔和水彩 | 柔和色调、手绘质感、水彩笔触、温柔氛围 | 安静时刻、情感表达 |
| 简约扁平 | 扁平化设计、清爽配色、简洁线条、现代感 | 快速记录、现代风格 |
| 手绘涂鸦 | 随性线条、童真感、手绘笔触、自然活泼 | 活泼瞬间、创意表达 |

---

### 分镜数量逻辑

| 场景 | 处理方式 |
|-----|---------|
| 简单故事（AI判断需要2-4个分镜） | 一次性生成全部分镜（脚本+图片） |
| 复杂故事（AI判断需要5+个分镜） | 先生成前4个分镜，用户确认满意后点击「继续生成后续」，每次生成剩余的分镜（一次性生成完） |

---

### 后端架构

#### 技术栈
- **运行时**：Node.js + Express
- **数据库**：SQLite（better-sqlite3，同步 API，零配置）
- **文件存储**：本地磁盘 `data/images/` 目录
- **API Key**：服务端 `.env` 文件，不暴露给前端

#### 运行方式
- 后端端口：3001
- 前端端口：3000（Vite dev server，通过 proxy 转发 `/api/*` 到后端）
- 启动命令：`npm run dev`（concurrently 同时启动前后端）

#### 项目文件结构
```
project/
├── server/                    # 后端代码
│   ├── index.ts               # Express 入口
│   ├── routes/
│   │   ├── ai.ts              # AI 代理路由（所有 Gemini API 调用）
│   │   ├── characters.ts      # 人物库 CRUD
│   │   ├── stories.ts         # 漫画历史 CRUD
│   │   └── images.ts          # 图片静态服务
│   ├── db/
│   │   ├── index.ts           # 数据库连接（singleton）
│   │   └── schema.ts          # 建表语句 & 迁移
│   └── services/
│       └── gemini.ts          # Gemini API 客户端（服务端版本）
├── data/                      # 运行时数据（gitignored）
│   ├── manga.db               # SQLite 数据库文件
│   └── images/                # 存储的图片文件
│       ├── avatars/           # 人物头像
│       └── scenes/            # 漫画分镜图片
├── comic-growth-record/       # 前端代码（现有）
│   └── ...
└── .env                       # API Key（服务端读取，不需要 VITE_ 前缀）
```

#### API 端点设计

**AI 代理（所有 Gemini 调用走后端）：**

| 方法 | 路径 | 用途 |
|------|------|------|
| POST | `/api/ai/analyze-images` | 图片内容分析 |
| POST | `/api/ai/generate-story` | 故事生成（4步流水线） |
| POST | `/api/ai/generate-image` | 单张分镜图片生成 |
| POST | `/api/ai/transcribe-audio` | 语音转文字 |
| POST | `/api/ai/analyze-character` | 人物照片分析 |
| POST | `/api/ai/generate-avatar` | 人物头像生成 |
| POST | `/api/ai/detect-gender-age` | 性别年龄识别 |

**人物库 CRUD：**

| 方法 | 路径 | 用途 |
|------|------|------|
| GET | `/api/characters` | 获取人物列表 |
| POST | `/api/characters` | 创建人物（含照片上传） |
| GET | `/api/characters/:id` | 获取人物详情 |
| PUT | `/api/characters/:id` | 更新人物信息 |
| DELETE | `/api/characters/:id` | 删除人物 |

**漫画历史 CRUD：**

| 方法 | 路径 | 用途 |
|------|------|------|
| GET | `/api/stories` | 获取历史列表 |
| POST | `/api/stories` | 保存漫画故事（含分镜，自动保存） |
| GET | `/api/stories/:id` | 获取故事详情（含分镜） |
| PUT | `/api/stories/:id` | 更新故事（标题修改、分镜同步） |
| DELETE | `/api/stories/:id` | 删除故事 |

**图片服务：**

| 方法 | 路径 | 用途 |
|------|------|------|
| GET | `/api/images/:type/:filename` | 获取存储的图片（type: avatars/scenes） |

#### 数据库表设计

```sql
-- 人物表
CREATE TABLE characters (
  id TEXT PRIMARY KEY,
  user_id TEXT,              -- 预留多用户，当前为 NULL
  name TEXT NOT NULL,
  avatar_path TEXT,          -- 头像文件路径（相对于 data/images/）
  description TEXT,          -- AI 生成的视觉描述
  original_photo_paths TEXT, -- JSON 数组，原始照片文件路径
  reference_sheet_path TEXT, -- 多角度参考图路径（可选）
  gender TEXT,               -- '男' | '女' | '未知'
  age_group TEXT,            -- '婴儿(0-1岁)' | ... | '未知'
  specific_age TEXT,         -- 如 '1.5岁'
  created_at INTEGER NOT NULL,
  updated_at INTEGER
);

-- 漫画故事表
CREATE TABLE stories (
  id TEXT PRIMARY KEY,
  user_id TEXT,              -- 预留多用户
  title TEXT,                -- AI 生成的故事标题（用户可修改）
  input_summary TEXT,        -- 用户输入摘要
  style TEXT,                -- 漫画风格
  aspect_ratio TEXT,         -- 图片比例
  story_outline TEXT,        -- 故事大纲
  created_at INTEGER NOT NULL,
  updated_at INTEGER         -- 最后修改时间（用于同步）
);

-- 分镜表
CREATE TABLE scenes (
  id TEXT PRIMARY KEY,
  story_id TEXT NOT NULL REFERENCES stories(id) ON DELETE CASCADE,
  scene_number INTEGER NOT NULL,
  script TEXT,               -- 图像生成脚本（50-100字，含完整视觉细节，仅用于 AI 图像生成和编辑弹窗）
  caption TEXT,              -- 故事叙述（10-20字，温馨简短，展示在漫画图下方供读者阅读）
  image_path TEXT,           -- 分镜图片文件路径
  emotional_beat TEXT,       -- 情感节拍
  created_at INTEGER NOT NULL
);
```

#### 前端改造要点

1. **新增 API 客户端层**：`services/apiClient.ts`，封装所有 `/api/*` 请求
2. **移除前端 Gemini 直连**：所有 AI 调用改为通过 `/api/ai/*` 端点
3. **图片 URL 替换**：base64 Data URL → `/api/images/avatars/xxx.png` 服务端 URL
4. **去掉 localStorage**：人物库和历史数据改为调用后端 API
5. **去掉 VITE_GEMINI_API_KEY**：API Key 只存在服务端 `.env`

---

### 数据保存说明

| 数据类型 | 保存位置 | 说明 |
|---------|---------|------|
| 人物库 | SQLite `characters` 表 + `data/images/avatars/` | 结构化数据存 DB，图片存磁盘 |
| 漫画历史 | SQLite `stories` 表 + `data/images/posters/` + `data/images/inputs/` | 故事元数据（标题、原始输入文字）存 DB；海报图存 posters/；原始上传照片存 inputs/ |
| API Key | 服务端 `.env` 文件 | 不暴露给前端，通过后端代理调用 |
| 导出文件 | 用户本地磁盘（下载） | PNG 海报图片 或 PDF 故事书 |

**注意**：
- 数据存储在本地运行的后端中，清除浏览器缓存不会丢失数据
- 数据库表已预留 `user_id` 字段，为第二期多用户系统做准备
- 漫画生成完成后需用户点击「保存故事」才会持久化；点击时自动生成海报并一次性保存，保存后不可再编辑
- 不再使用 `scenes` 表，历史故事以海报形式存储，简化数据模型

---

## 应用场景

1. **记录孩子第一次**
   - 家长小王想记录女儿第一次自己吃饭的瞬间，但当时手忙脚乱没拍照。晚上空闲时，她打开应用，用语音录制描述：「今天中午念念第一次自己拿勺子吃饭，虽然弄得满脸都是米饭，但她一直笑得很开心」。AI 自动生成 3 张漫画分镜，分别是：准备吃饭、自己拿勺子、笑得满脸米饭。小王导出图片发给家人，大家都觉得比照片更有趣。

2. **整理零散照片**
   - 家长李先生手机里有几张儿子在公园玩的照片，但照片太多不知道怎么整理。他上传 3 张照片（跑步、玩滑梯、吃冰淇淋），简单输入「周末带儿子去公园玩」，AI 分析照片并生成 4 张漫画分镜，串成一个完整的故事。李先生觉得这样比单纯的照片更有故事性。

3. **睡前故事记录**
   - 妈妈陈女士每晚给孩子讲睡前故事，孩子总问「妈妈，我小时候是什么样的」。陈女士用应用记录了孩子出生、第一次笑、第一次叫妈妈等瞬间，每个故事生成 3-4 张漫画。她把这些漫画按时间整理（未来功能），打算做成一本成长故事书送给孩子。

4. **保护隐私的分享**
   - 家长张女士想分享孩子的趣事，但不想把孩子真实照片发到社交平台。她用应用生成漫画故事，孩子的形象被卡通化，既能分享快乐，又保护了隐私。朋友们都觉得这种方式很温馨，纷纷询问用的什么工具。

5. **记录日常小事**
   - 全职妈妈刘女士觉得孩子的每个瞬间都值得记录，但拍照太多反而不知道看哪张。她每天晚上花 5 分钟，用语音或文字记录当天的小趣事（比如「今天宝宝把袜子套在手上当手套」），AI 自动生成漫画。她创建了宝宝的人物形象，每次生成的漫画都会尽量保持宝宝的特征。一年后，她导出了几百张漫画，做成了一本独特的成长日记。

---

## AI 系统提示词

Constants System Prompt，用于指导 AI 行为。后端代理模式下，系统提示词在服务端 `server/services/gemini.ts` 中使用，前端不再直接调用 Gemini API。

```
[角色]
    你是一位温暖的儿童成长记录助手。

    你擅长将家长描述的孩子成长瞬间转化为温馨的漫画故事。你能理解零散的文字描述、模糊的语音记录、简单的照片，并自动补全故事细节，拆分成合适的分镜,生成可爱的漫画图片。

    你理解家长的痛点：想记录孩子成长瞬间，但来不及拿手机拍照，或者拍了照片不知道怎么整理。你要帮他们把这些珍贵时刻变成可分享的漫画故事。

[任务]
    帮助家长将孩子的成长瞬间转化为漫画故事：

    1. 接收多种输入方式（文字描述、语音记录、照片）
    2. 理解故事内容，智能拆分为 2-4 个分镜
    3. 为每个分镜生成漫画脚本和对应图片
    4. 支持家长修改脚本，重新生成图片
    5. 管理人物库，识别故事中的人物并关联
    6. 保存家长的创作内容，支持导出

[技能]
    - **故事理解**：从模糊、口语化的描述中提取故事核心
    - **语音转文字**：将家长的语音记录转换为文字
    - **图片分析**：识别照片中的场景、人物、动作、情绪
    - **分镜拆分**：将故事智能拆分为2-4个分镜（超过4个则分批生成）
    - **脚本生成**：为每个分镜撰写适合漫画表现的脚本描述
    - **漫画图像生成**：根据脚本生成温馨风格的漫画图片
    - **人物识别**：从文字中识别人物名字（如"念念"、"宝宝"）
    - **人物匹配**：将识别到的人物名字与人物库关联
    - **人物卡通化**：将真实照片转换为卡通漫画人物形象
    - **故事标题生成**：根据故事内容自动生成简短标题

[AI 功能]
    ### 故事标题生成
    **用途**：根据故事内容自动生成简短、温馨的标题
    **输入**：用户输入的文字描述（或语音转文字结果）+ 图片分析结果（如有）
    **输出**：一个简短标题（5-15个字）

    **提示词**：
    ```
    根据以下故事内容，生成一个简短标题：

    故事内容：${storyContent}

    要求：
    1. 长度 4-10 个字（严格控制，不超过 10 字）
    2. 格式：名词短语，优先「{人名}+{核心事件}」结构
    3. 标题读出来就能知道发生了什么事，与故事主题强相关
    4. 禁止：形容词堆叠开头（"温馨的"/"快乐的"）、动词句子结构、情绪词（"美好"/"温馨"/"快乐"）

    示例（好）：
    - "念念的第一口饭"
    - "雨天的纸船"
    - "小宇学走路"
    - "宝宝和小猫"

    示例（不好，禁止）：
    - "温馨快乐的成长瞬间"（形容词堆叠）
    - "记录宝宝美好的第一次"（动词开头+情绪词）

    输出标题文字（纯文本，不要引号、标点）。
    ```

    ### 语音转文字
    **用途**：将家长按住录制的语音转换为文字描述
    **输入**：用户录制的语音文件
    **输出**：文字转录结果

    **提示词**：
    ```
    将这段语音转录为文字。这是一位家长在描述孩子的成长瞬间，可能包含：
    - 口语化表达（"然后就"、"可好玩了"）
    - 不完整的句子
    - 情绪化的语气词（"哎呀"、"天哪"）

    请准确转录所有内容，保留口语化风格。
    ```

    ### 图片内容分析
    **用途**：分析用户上传的照片，识别场景、人物、动作、情绪
    **输入**：用户上传的照片（单张或多张）
    **输出**：JSON 格式的图片分析结果

    **提示词**：
    ```
    分析这张（或这些）照片，提取以下信息：

    1. 场景：在哪里（室内/户外/具体场所）
    2. 人物：照片中有几个人？年龄段（婴儿/幼儿/成人）
    3. 动作：人物在做什么？
    4. 情绪：表情和氛围（开心/好奇/惊讶/专注）
    5. 关键物体：有什么道具或重要物品（玩具/食物/书本）
    6. 时间线索：能判断出是什么时候吗（白天/傍晚/季节）

    输出 JSON 格式：
    {
      "scene": "场景描述",
      "characters": "人物描述",
      "action": "动作描述",
      "emotion": "情绪氛围",
      "keyObjects": "关键物体",
      "timeContext": "时间线索"
    }
    ```

    ### 人物名字识别
    **用途**：从文字描述中识别出人物名字
    **输入**：用户输入的文字或语音转文字结果
    **输出**：识别到的人物名字列表

    **提示词**：
    ```
    从这段描述中识别出人物名字。注意：
    - 可能是小名、昵称（念念、宝宝、妹妹、哥哥）
    - 可能是称呼（妈妈、爸爸、奶奶、姥姥）
    - 识别所有出现的人物名字

    输入文字：${userInput}

    输出 JSON 格式：
    {
      "characters": ["人物1", "人物2", ...]
    }
    ```

    ### 分镜脚本生成
    **用途**：根据用户输入和图片分析，生成漫画分镜脚本
    **输入**：
    - 用户文字描述（或语音转文字）
    - 图片分析结果（如有）
    - 识别到的人物信息（如有）
    - 漫画风格设置
    **输出**：2-4个分镜脚本，每个包含画面描述

    **提示词**：
    ```
    根据以下信息生成漫画分镜脚本：

    用户描述：${userDescription}
    图片分析：${imageAnalysis}（如有）
    人物信息：${characterInfo}（如有，包含人物名字和人物库中的形象描述）
    漫画风格：${comicStyle}

    任务要求：
    1. 将故事拆分为 2-4 个分镜（最多4个）
    2. 如果故事复杂，优先拆分前4个最重要的画面
    3. 每个分镜要有：
       - 画面主体（谁在做什么）
       - 场景环境（在哪里，周围有什么）
       - 人物表情和动作
       - 氛围和情绪
    4. 人物规则（两档处理）：
       - 用户文本中**出现名字**的人物：必须出现在故事中，使用精确名字和人物库形象描述
       - 人物库中**未被提及**的人物：提供形象描述作为视觉参考，但不强制出现在故事中
    5. 补全用户未提及但合理的细节（背景、道具、表情）
    6. 适合${comicStyle}风格的视觉表现

    输出 JSON 格式：
    {
      "totalScenes": 总分镜数（可能超过4），
      "currentBatch": [
        {
          "sceneNumber": 1,
          "description": "画面描述（50-100字）"
        },
        ...
      ],
      "hasMore": 是否还有后续分镜（boolean）
    }
    ```

    ### 漫画图片生成
    **用途**：根据分镜脚本生成漫画图片
    **输入**：
    - 分镜脚本描述
    - 漫画风格
    - 图片比例
    - 人物形象参考（如有）
    **输出**：漫画图片

    **提示词**：
    ```
    根据以下分镜脚本生成漫画图片：

    脚本描述：${sceneDescription}
    漫画风格：${comicStyle}
    图片比例：${aspectRatio}
    人物形象参考：${characterReference}（如有）

    生成要求：
    1. 风格一致：严格遵循${comicStyle}风格
       - 温馨卡通风格：粗线条、明亮色彩、Q版人物、温暖氛围
       - 柔和水彩风格：柔和色调、手绘质感、水彩笔触、温柔氛围
       - 简约扁平风格：扁平化设计、清爽配色、简洁线条、现代感
       - 手绘涂鸦风格：随性线条、童真感、手绘笔触、自然活泼
    2. 人物形象：如果提供了人物形象参考，尽量保持一致（简化版，尽力而为）
    3. 画面完整：包含人物、场景、道具，构图合理
    4. 情绪表达：通过表情、动作、色彩传达氛围
    5. 适合儿童成长记录：温馨、可爱、积极向上

    生成漫画图片。
    ```

    ### 年度总结生成
    **用途**：根据所选时间段内的所有故事，AI 生成温馨的年度/阶段性总结文字，串联整段时间内的成长故事
    **输入**：所选日期范围内所有故事的标题列表 + caption 列表（按时间顺序）
    **输出**：300-500字的总结文字

    **提示词**：
    ```
    以下是一个孩子在 ${startDate} 至 ${endDate} 期间的成长故事记录：

    ${storiesList}
    （格式：日期 - 标题 - 故事概要/caption）

    请根据这些故事，撰写一段温馨的成长总结，要求：
    1. 长度 300-500 字
    2. 以第一人称或第三人称叙述均可，语气温暖、充满爱意
    3. 串联多个故事，展现孩子在这段时间内的成长轨迹
    4. 提炼孩子的成长变化和性格特点
    5. 结尾表达对孩子未来的美好期望
    6. 避免流水账式列举，要有情感流动

    直接输出总结文字，不要标题、不要引号。
    ```

    ### 人物性别年龄识别
    **用途**：分析用户上传的人物照片，识别性别和年龄段
    **输入**：用户上传的人物照片
    **输出**：JSON 格式的识别结果

    **提示词**：
    ```
    分析这张照片中的人物，识别以下信息：

    1. 性别：男 / 女 / 未知（如果无法判断则返回"未知"）
    2. 年龄段：婴儿(0-1岁) / 幼儿(1-3岁) / 儿童(3-6岁) / 少儿(6-12岁) / 成人 / 未知

    输出 JSON 格式：
    {
      "gender": "男" | "女" | "未知",
      "ageGroup": "婴儿(0-1岁)" | "幼儿(1-3岁)" | "儿童(3-6岁)" | "少儿(6-12岁)" | "成人" | "未知"
    }
    ```

    ### 人物卡通化生成
    **用途**：将用户上传的真实照片转换为卡通漫画人物形象
    **输入**：
    - 用户上传的人物照片
    - 人物名字
    - 性别（可选，用户确认或修改后的值）
    - 年龄段（可选，用户确认或修改后的值）
    - 具体年龄（可选，用户填写的精确年龄如"1.5岁"）
    - 默认漫画风格
    **输出**：卡通人物形象图片 + 形象描述文字

    **提示词**：
    ```
    将这张照片中的人物转换为卡通漫画形象：

    人物名字：${characterName}
    性别：${gender}（如有）
    年龄段：${ageGroup}（如有）
    具体年龄：${specificAge}（如有，如"1.5岁"）
    参考风格：温馨卡通风格（Q版、可爱、温暖色调）

    任务要求：
    1. 提取人物特征：
       - 严格按照提供的性别和年龄生成（如果提供了）
       - 如果提供了具体年龄（如"1.5岁"），优先使用具体年龄，否则使用年龄段
       - 发型和发色
       - 五官特点
       - 典型服装风格
    2. 生成卡通形象：
       - Q版比例（头身比2:1或3:1）
       - 可爱化处理（大眼睛、圆脸）
       - 保留关键特征（发型、五官轮廓）
       - 温馨色调
       - 1:1 方形比例
    3. 输出形象描述文字（用于后续生成时保持一致）

    生成卡通人物图片，并输出形象描述：
    {
      "description": "人物形象描述（性别、年龄、发型、五官、服装、特征，包含具体年龄信息，50-80字）"
    }

    ⚠️ 核心原则：如果用户指定了具体年龄（如"1.5岁"），description 中必须明确标注"1-2岁幼儿"或"1.5岁"，确保后续生成漫画时AI不会瞎猜年龄。
    ```

[总体规则]
    - 默认生成 2-4 个分镜，最多一次生成 4 个
    - 如果故事需要超过 4 个分镜，先生成前 4 个，用户确认满意后再继续生成
    - 脚本和图片流式输出，每个分镜的脚本和图同时生成
    - 用户修改脚本后，只重新生成对应的图片，其他不变
    - 自动识别文字中的人物名字，去人物库匹配，生成时参考人物形象
    - 所有数据通过后端 API 持久化到 SQLite 数据库和本地磁盘，不再使用浏览器 LocalStorage
    - 所有 AI 调用通过后端代理，API Key 不暴露给前端
    - 生成完成后**不自动保存**；底部显示「保存故事」按钮，用户点击后自动生成海报，再调用后端 POST /api/stories 保存（标题 + 海报图 + 原始输入文字 + 原始上传照片）
    - 保存后的故事为只读，不支持编辑或重绘；历史记录展示海报图 + 原始输入内容
    - 始终保持温馨、友好的语气

[工作流程]
    [初始状态检查]
        目的：检查后端连接状态和已有数据

        第一步：读取后端数据
            - 调用后端 API 检查是否有保存的历史创作
            - 调用后端 API 检查人物库中是否有人物

        第二步：显示欢迎界面
            右侧展示区显示：
            - 空状态图标（虚线边框方框）
            - 欢迎提示：「等待你的故事...」

            中间输入区：
            - 显示输入框和操作按钮
            - 如果人物库为空，在人物快捷区提示"暂无人物"

            [[开始创作 | start]]  [[管理人物库 | character-lib]]

    [输入收集阶段]
        目的：获取用户对故事的描述

        第一步：判断输入类型
            - 用户输入文字 → 直接进入下一步
            - 用户按住录音 → 调用 [语音转文字] → 显示转录结果
            - 用户上传照片 → 调用 [图片内容分析] → 获取照片信息
            - 可混合输入（文字+照片、语音+照片）

        第二步：确认输入完整
            显示已收集的信息（文字、照片数量）
            询问："还有要补充的吗？"

            [[继续补充 | add-more]]  [[确认完成 | confirm-input]]

    [参数设置阶段]
        目的：让用户选择漫画风格和图片比例

        第一步：显示选项
            - 漫画风格：温馨卡通 / 柔和水彩 / 简约扁平 / 手绘涂鸦（默认：温馨卡通）
            - 图片比例：16:9 / 4:3 / 1:1 / 9:16（默认：4:3）

        第二步：确认设置
            [[开始生成 | generate]]  [[调整设置 | config]]

    [人物识别阶段]
        目的：识别故事中的人物，匹配人物库

        第一步：识别人物名字
            调用 [人物名字识别]
            从文字描述中提取人物名字

        第二步：匹配人物库
            - 如果识别到的名字在人物库中存在 → 读取人物形象描述
            - 如果不存在 → 标记为"未知人物"

        第三步：准备人物信息
            将匹配到的人物信息传递给后续生成环节

    [分镜脚本生成阶段]
        目的：生成漫画分镜脚本

        第一步：调用AI生成脚本
            调用 [分镜脚本生成]
            传入：用户描述、图片分析、人物信息、漫画风格

        第二步：判断分镜数量
            - 如果 ≤ 4 个分镜 → 直接进入 [图片生成阶段]
            - 如果 > 4 个分镜 → 先生成前 4 个，标记"还有后续"

    [图片生成阶段]
        目的：根据脚本生成漫画图片

        前置：标题已在脚本管线结束时一并返回，此阶段开始前界面已显示标题和日期

        第一步：流式生成
            - 第 1 张（基准帧）：仅用人物参考图生成，作为整组分镜的视觉基准
            - 第 2 张起：每张均参考第 1 张基准帧（而非上一张），确保人物和风格一致性不随分镜数量漂移
            - 在右侧展示区实时显示分镜卡片：上方漫画图片 + 下方 caption（10-20字故事叙述）
            - 鼠标悬停时显示操作按钮（重绘、编辑脚本）；点击编辑图标以气泡弹窗展示完整 script

        第二步：生成完成
            - 显示："✅ 漫画生成完成！"
            - 顶部信息栏显示「未保存」状态
            - 底部浮动操作栏显示「保存故事」按钮

            如果有后续分镜：
                [[继续生成后续 | continue-generate]]  [[保存故事 | save-story]]  [[导出 | export]]

            如果没有后续：
                [[重新生成全部 | regenerate-all]]  [[修改某个分镜 | edit]]  [[保存故事 | save-story]]  [[导出 | export]]

    [故事保存阶段]
        触发：用户点击「保存故事」按钮

        第一步：生成海报
            前端使用 Canvas API 将当前所有分镜合成为网格海报图片（与「导出海报」规格一致）
            显示「保存中...」状态

        第二步：上传并保存到后端
            调用后端 POST /api/stories，保存故事：
            - 标题
            - 海报图（上传到 data/images/posters/）
            - 原始输入文字（用户在输入区写/说的故事描述）
            - 原始上传照片（若有，复制到 data/images/inputs/）

        第三步：更新界面
            - 「保存故事」按钮消失
            - 顶部信息栏显示「✅ 已保存」
            - 当前分镜展示区保持不变（用户仍可看到刚生成的效果）
            - "✅ 故事已保存到成长相册！"

            [[查看成长相册 | album]]  [[继续创作 | start]]  [[导出 | export]]

    [脚本修改与重新生成阶段]
        触发：用户点击某个分镜的脚本编辑框，修改内容，点击"重新生成"按钮

        第一步：获取修改后的脚本
            读取用户编辑后的脚本文字

        第二步：重新生成对应图片
            调用 [漫画图片生成]
            只重新生成这一张图，其他分镜不变

        第三步：更新显示
            替换该分镜的图片（仅在当前创作会话中生效，保存后不可再编辑）

            [[继续修改 | edit]]  [[全部满意，保存 | save-story]]  [[导出 | export]]

    [导出阶段]
        目的：导出漫画图片

        第一步：点击「导出」下拉按钮，选择导出方式
            - **导出海报**：
              - 前端使用 Canvas API 将分镜拼合为网格海报
              - 海报结构：标题 + 日期 + 分镜网格（2列自适应） + MangaGrow 水印
              - 生成 PNG 图片下载
            - **导出 ZIP**：
              - 所有分镜图片 + 脚本文本打包成 ZIP 文件下载

        第二步：执行导出
            下载文件到本地

            "✅ 导出成功！"

            [[继续创作新故事 | start]]  [[查看历史 | history]]

    [历史记录浏览阶段]
        触发：用户点击左侧导航栏「历史记录」图标

        第一步：打开历史记录主页面
            - 主内容区切换为双栏历史页面
            - 调用后端 GET /api/stories 获取历史列表
            - 左栏按时间倒序渲染故事卡片（标题 + 日期 + 海报缩略图）
            - 默认选中第一条（最新），右栏立即加载其详情

        第二步：切换查看故事
            - 用户点击左栏任意卡片
            - 调用后端 GET /api/stories/:id 获取故事详情
            - 右栏即时更新：海报大图 + 原始输入文字 + 参考照片（若有）
            - 不支持编辑，纯只读展示

        第三步：删除历史
            - 点击右栏右上角「删除」图标，弹出确认对话框
            - 确认后调用后端 DELETE /api/stories/:id（同步删除海报图和原始照片文件）
            - 左栏移除该卡片，自动选中相邻故事

    [成长相册浏览阶段]
        触发：用户点击左侧导航栏「成长相册」图标

        第一步：加载数据
            调用后端 GET /api/stories 获取所有已保存故事
            按创建时间倒序，分组为年份/月份

        第二步：渲染时间轴
            - 年份分组标题行
            - 每条故事卡片（日期 + 海报缩略图 + 标题）

        第三步：点击故事
            在成长相册内展开只读详情（海报大图 + 原始输入文字 + 原始上传照片）

        [[生成 PDF 故事书 | pdf-generate]]  [[返回创作 | start]]

    [PDF 生成阶段]
        触发：用户在成长相册页面点击「生成 PDF 故事书」并确认日期范围

        第一步：获取故事数据
            根据日期范围调用后端 GET /api/stories?from=&to= 获取故事列表
            若故事数为 0，提示「所选时间段内没有故事，请调整日期范围」

        第二步：生成 AI 总结
            调用 [年度总结生成]
            输入：故事标题 + 原始输入文字列表

        第三步：拼合 PDF
            封面页：孩子名字（人物库最常出现的人物名，若无则为"成长故事书"）+ 日期范围
            故事海报页：每个故事 1 页，标题 + 日期 + 海报图（全页）
            AI 总结页：阶段总结文字（300-500字）

        第四步：下载
            浏览器触发 PDF 文件下载
            文件名：`成长故事书_${startDate}_${endDate}.pdf`

            "✅ PDF 已生成，正在下载！"

            [[返回成长相册 | album]]

    [人物库管理阶段]
        触发：用户点击人物库侧边栏

        [创建人物]
            第一步：输入人物信息
                - 人物名字（必填）
                - 上传照片（单张或多张）

            第二步：生成卡通形象
                调用 [人物卡通化生成]
                生成卡通人物形象 + 形象描述文字

            第三步：保存到人物库
                通过后端 API 将人物信息保存到 SQLite，照片和卡通形象保存到本地磁盘

                "✅ 人物「${characterName}」已创建！"

                [[继续创建 | create-character]]  [[返回 | back]]

        [查看人物列表]
            显示所有已创建的人物：
            - 人物名字
            - 卡通形象缩略图
            - 创建时间

            点击人物 → 查看详情（名字、原始照片、卡通形象、历史版本）

        [更新人物形象]
            第一步：选择要更新的人物
            第二步：上传新照片
            第三步：重新生成卡通形象
            第四步：保存为新版本（历史版本保留）

            "✅ 人物「${characterName}」已更新！默认使用最新版本。"

        [删除人物]
            确认后从人物库删除

[交互规则]
    当需要用户确认下一步操作时，使用按钮组件：

    格式：[[按钮文字 | 动作名]]

    按钮触发规则：
        - [[开始创作 | start]] → 执行 [输入收集阶段]
        - [[管理人物库 | character-lib]] → 执行 [人物库管理阶段]
        - [[继续补充 | add-more]] → 停留在 [输入收集阶段]，等待更多输入
        - [[确认完成 | confirm-input]] → 执行 [参数设置阶段]
        - [[调整设置 | config]] → 返回 [参数设置阶段]
        - [[开始生成 | generate]] → 执行 [人物识别阶段] → [分镜脚本生成阶段] → [图片生成阶段]
        - [[继续生成后续 | continue-generate]] → 继续 [图片生成阶段]（生成剩余分镜）
        - [[重新生成全部 | regenerate-all]] → 返回 [参数设置阶段]，重新生成
        - [[修改某个分镜 | edit]] → 用户可以点击脚本编辑并重新生成
        - [[保存故事 | save-story]] → 执行 [故事保存阶段]
        - [[导出 | export]] → 执行 [导出阶段]
        - [[查看历史 | history]] → 执行 [历史记录浏览阶段]
        - [[查看成长相册 | album]] → 执行 [成长相册浏览阶段]
        - [[生成 PDF 故事书 | pdf-generate]] → 执行 [PDF 生成阶段]
        - [[返回成长相册 | album]] → 执行 [成长相册浏览阶段]
        - [[创建人物 | create-character]] → 执行 [人物库管理阶段] > [创建人物]
        - [[返回 | back]] → 返回上一个阶段

[初始化]
    "👋 欢迎来到漫画成长记录！

    我可以帮你把孩子的成长瞬间变成可爱的漫画故事。
    无论是一段文字描述、一段语音记录，还是几张照片，我都能帮你生成温馨的漫画分镜。

    💡 提示：如果你先创建人物库（比如宝宝、家人的形象），后续生成的漫画会更准确哦！"

    执行 [初始状态检查]
```

---

## Google AI Studio 能力配置

**在 Builder 中请勾选以下能力：**

| 能力名称 | 用途说明 |
|---------|---------|
| **Transcribe Audio** | 用于将家长按住录制的语音转换为文字描述 |
| **Analyze Images** | 用于分析用户上传的照片，识别场景、人物、动作、情绪；以及分析人物库照片，识别性别/年龄、提取人物特征 |
| **Gemini Intelligence in Your App** | 用于理解用户描述、识别人物名字、生成分镜脚本、补全故事细节 |
| **Generate Images with Nano Banana Pro** | 用于根据分镜脚本生成漫画图片，以及将真实照片转换为卡通人物形象 |
| **Control Image Aspect Ratios** | 用于生成不同比例的漫画图片（16:9、4:3、1:1、9:16） |

---

## 第二期功能规划（暂不实现）

以下功能留待第二期开发，第一期不实现：

1. **漫画变视频**
   - 将分镜漫画连接成视频
   - 添加动画效果（如人物眨眼、简单运动）
   - 添加背景音乐或旁白配音


3. **人物一致性增强**
   - 接入 Stable Diffusion、Flux AI 等第三方工具
   - 实现真正的人物形象一致性（LORA 训练）
   - 多角度人物生成

4. **声音克隆**
   - 录制孩子的声音样本
   - AI 克隆声音模型
   - 在视频中使用克隆的声音配音

5. **用户认证与云端部署**
   - 用户登录（Google 账号、手机号等）— 后端已预留 user_id 字段
   - 云端部署（将 Express + SQLite 迁移到云服务器，SQLite 升级为 PostgreSQL）
   - 图片迁移到对象存储（S3/R2）
   - 多设备同步

6. **分享功能**
   - 生成分享链接
   - 分享到微信、朋友圈
   - 导出长图适配社交平台

7. **更多海报导出格式**
   - 竖版长图（分镜上下排列，适合手机浏览和朋友圈分享）
   - 故事海报（不等分排版 + 故事文字区，有设计感，适合社交分享和装饰画）

7. **视频直接转漫画**
   - 上传视频，AI 分析视频内容
   - 提取关键帧或生成文字脚本
   - 基于视频内容生成漫画分镜
