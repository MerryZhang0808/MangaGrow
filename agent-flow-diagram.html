<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MangaGrow â€” Agent æ–¹æ³•è°ƒç”¨å›¾</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
  background: #0d1117;
  color: #e6edf3;
  min-height: 100vh;
  padding: 32px 24px 80px;
}

h1 {
  text-align: center;
  font-size: 26px;
  font-weight: 700;
  color: #f0f6fc;
  margin-bottom: 6px;
  letter-spacing: 0.5px;
}
.subtitle {
  text-align: center;
  color: #8b949e;
  font-size: 13px;
  margin-bottom: 40px;
}

/* Legend */
.legend {
  display: flex;
  justify-content: center;
  gap: 24px;
  flex-wrap: wrap;
  margin-bottom: 36px;
}
.legend-item {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 12px;
  color: #8b949e;
}
.legend-dot {
  width: 12px; height: 12px;
  border-radius: 50%;
}
.legend-line {
  width: 28px; height: 2px;
}

/* Tab bar */
.tabs {
  display: flex;
  justify-content: center;
  gap: 0;
  margin-bottom: 32px;
  background: #161b22;
  border: 1px solid #30363d;
  border-radius: 10px;
  padding: 4px;
  width: fit-content;
  margin-left: auto;
  margin-right: auto;
}
.tab-btn {
  padding: 8px 20px;
  border: none;
  background: transparent;
  color: #8b949e;
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  border-radius: 7px;
  transition: all 0.2s;
}
.tab-btn.active {
  background: #21262d;
  color: #f0f6fc;
  box-shadow: 0 1px 3px rgba(0,0,0,0.4);
}
.tab-btn:hover:not(.active) { color: #c9d1d9; }

/* Diagram area */
.diagram { display: none; }
.diagram.active { display: block; }

/* ==================== PIPELINE DIAGRAM ==================== */
.pipeline-container {
  max-width: 980px;
  margin: 0 auto;
}

.pipeline-section {
  margin-bottom: 48px;
}
.section-label {
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: #8b949e;
  margin-bottom: 16px;
  padding-left: 2px;
}

/* Step box */
.step-box {
  border-radius: 10px;
  border: 1px solid #30363d;
  background: #161b22;
  padding: 16px 20px;
  position: relative;
  cursor: pointer;
  transition: all 0.2s;
}
.step-box:hover {
  border-color: #58a6ff;
  box-shadow: 0 0 0 2px rgba(88,166,255,0.12);
  transform: translateY(-1px);
}
.step-box .step-num {
  position: absolute;
  top: -11px;
  left: 16px;
  background: #0d1117;
  padding: 0 8px;
  font-size: 11px;
  font-weight: 700;
  border-radius: 20px;
  border: 1px solid #30363d;
}
.step-box .fn-name {
  font-size: 15px;
  font-weight: 700;
  font-family: 'SF Mono', 'Fira Code', monospace;
  margin-bottom: 6px;
}
.step-box .fn-desc {
  font-size: 12px;
  color: #8b949e;
  margin-bottom: 10px;
  line-height: 1.5;
}
.step-box .model-badge {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  padding: 3px 10px;
  border-radius: 20px;
  font-size: 11px;
  font-weight: 600;
}
.badge-text {
  background: rgba(88,166,255,0.12);
  border: 1px solid rgba(88,166,255,0.3);
  color: #58a6ff;
}
.badge-image {
  background: rgba(163,113,247,0.12);
  border: 1px solid rgba(163,113,247,0.3);
  color: #a371f7;
}
.badge-retry {
  background: rgba(56,189,141,0.1);
  border: 1px solid rgba(56,189,141,0.3);
  color: #3fb950;
  margin-left: 8px;
}
.step-box .io-row {
  display: flex;
  gap: 12px;
  margin-top: 12px;
  flex-wrap: wrap;
}
.io-chip {
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 11px;
  padding: 3px 10px;
  border-radius: 6px;
  background: #21262d;
  border: 1px solid #30363d;
  color: #c9d1d9;
}
.io-chip .io-label {
  font-size: 10px;
  font-weight: 700;
  opacity: 0.6;
  margin-right: 2px;
}

/* Arrow between steps */
.arrow-down {
  display: flex;
  justify-content: center;
  padding: 6px 0;
  position: relative;
}
.arrow-down svg { opacity: 0.5; }
.arrow-label {
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  top: 50%;
  margin-top: -9px;
  background: #0d1117;
  padding: 1px 8px;
  font-size: 10px;
  color: #8b949e;
  white-space: nowrap;
  border-radius: 10px;
}

/* Parallel group */
.parallel-group {
  display: flex;
  gap: 16px;
  align-items: flex-start;
}
.parallel-group .step-box { flex: 1; }
.parallel-separator {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 0 4px;
  min-width: 32px;
  position: relative;
}
.parallel-separator span {
  font-size: 10px;
  color: #3fb950;
  font-weight: 700;
  background: #0d1117;
  padding: 2px 6px;
  border-radius: 10px;
  border: 1px solid rgba(63,185,80,0.3);
  position: relative;
  z-index: 1;
}
.parallel-separator::before {
  content: '';
  position: absolute;
  left: 50%;
  top: 0; bottom: 0;
  width: 1px;
  background: rgba(63,185,80,0.25);
  border: none;
  border-left: 1px dashed rgba(63,185,80,0.4);
}

/* Decision box (review step) */
.decision-note {
  margin-top: 8px;
  padding: 8px 12px;
  border-radius: 6px;
  background: rgba(248,200,97,0.06);
  border: 1px dashed rgba(248,200,97,0.3);
  font-size: 11px;
  color: #e3b341;
  display: flex;
  align-items: flex-start;
  gap: 6px;
}

/* Route table */
.route-section {
  max-width: 980px;
  margin: 0 auto;
}
.route-table {
  width: 100%;
  border-collapse: collapse;
  border-radius: 10px;
  overflow: hidden;
  border: 1px solid #30363d;
  font-size: 13px;
}
.route-table th {
  background: #161b22;
  padding: 10px 16px;
  text-align: left;
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 1px;
  text-transform: uppercase;
  color: #8b949e;
  border-bottom: 1px solid #30363d;
}
.route-table td {
  padding: 12px 16px;
  border-bottom: 1px solid #21262d;
  vertical-align: top;
}
.route-table tr:last-child td { border-bottom: none; }
.route-table tr:hover td { background: #161b22; }
.method-post {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 4px;
  background: rgba(56,189,141,0.12);
  border: 1px solid rgba(56,189,141,0.3);
  color: #3fb950;
  font-size: 11px;
  font-weight: 700;
  font-family: monospace;
}
.route-path {
  font-family: 'SF Mono', monospace;
  color: #79c0ff;
  font-size: 12px;
}
.service-tag {
  display: inline-block;
  padding: 1px 6px;
  border-radius: 4px;
  font-size: 10px;
  font-weight: 600;
  margin-right: 4px;
}
.tag-story { background: rgba(88,166,255,0.12); color: #58a6ff; }
.tag-char { background: rgba(163,113,247,0.12); color: #a371f7; }
.tag-input { background: rgba(56,189,141,0.12); color: #3fb950; }
.tag-image { background: rgba(248,200,97,0.12); color: #e3b341; }

/* ==================== OVERVIEW DIAGRAM ==================== */
.overview-container {
  max-width: 1100px;
  margin: 0 auto;
}

.arch-grid {
  display: grid;
  grid-template-columns: 1fr 80px 1fr 80px 1fr;
  gap: 0;
  align-items: start;
  margin-bottom: 40px;
}

.arch-col {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.arch-connector {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding-top: 40px;
}
.arch-connector svg { opacity: 0.4; }
.arch-connector span {
  font-size: 10px;
  color: #8b949e;
  margin-top: 4px;
  text-align: center;
}

.arch-card {
  border-radius: 10px;
  padding: 14px 16px;
  border: 1px solid #30363d;
  background: #161b22;
}
.arch-card.highlight {
  border-color: #388bfd;
  background: rgba(56,139,253,0.05);
}
.arch-card .card-title {
  font-size: 12px;
  font-weight: 700;
  margin-bottom: 8px;
  color: #f0f6fc;
  display: flex;
  align-items: center;
  gap: 6px;
}
.arch-card .card-title .icon {
  font-size: 14px;
}
.arch-card .card-items {
  display: flex;
  flex-direction: column;
  gap: 4px;
}
.arch-card .item {
  font-size: 11px;
  color: #8b949e;
  padding: 3px 8px;
  border-radius: 4px;
  background: #21262d;
  font-family: monospace;
}
.arch-card .item.em { color: #c9d1d9; }

.arch-col-label {
  font-size: 10px;
  font-weight: 700;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  color: #8b949e;
  margin-bottom: 12px;
  text-align: center;
}

/* Flow diagram SVG-based */
.flow-svg-wrapper {
  width: 100%;
  overflow-x: auto;
  padding: 8px 0;
}

/* Tooltip */
.tooltip {
  position: fixed;
  z-index: 1000;
  pointer-events: none;
  background: #21262d;
  border: 1px solid #30363d;
  border-radius: 8px;
  padding: 12px 16px;
  max-width: 300px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.5);
  font-size: 12px;
  line-height: 1.6;
  display: none;
}
.tooltip .tt-title {
  font-size: 13px;
  font-weight: 700;
  color: #f0f6fc;
  margin-bottom: 6px;
  font-family: monospace;
}
.tooltip .tt-model {
  margin-bottom: 4px;
}
.tooltip .tt-row {
  color: #8b949e;
  margin-bottom: 2px;
}
.tooltip .tt-row strong { color: #c9d1d9; }

/* Color coding */
.color-story { color: #58a6ff; }
.color-char { color: #a371f7; }
.color-input { color: #3fb950; }
.color-image { color: #e3b341; }
.color-text-model { color: #58a6ff; }
.color-image-model { color: #a371f7; }

/* ========== Scrollable full flow ========== */
.full-flow {
  max-width: 980px;
  margin: 0 auto;
}

/* Header banner */
.flow-banner {
  border-radius: 10px;
  padding: 16px 20px;
  margin-bottom: 20px;
  border: 1px solid;
  display: flex;
  align-items: center;
  gap: 14px;
}
.flow-banner.story { border-color: rgba(88,166,255,0.3); background: rgba(88,166,255,0.05); }
.flow-banner.char { border-color: rgba(163,113,247,0.3); background: rgba(163,113,247,0.05); }
.flow-banner.input { border-color: rgba(56,189,141,0.3); background: rgba(56,189,141,0.05); }
.flow-banner.img { border-color: rgba(248,200,97,0.3); background: rgba(248,200,97,0.05); }
.flow-banner .banner-icon { font-size: 24px; }
.flow-banner .banner-info { flex: 1; }
.flow-banner .banner-title { font-size: 15px; font-weight: 700; margin-bottom: 2px; }
.flow-banner .banner-sub { font-size: 12px; color: #8b949e; }
.flow-banner .banner-entry { font-family: monospace; font-size: 11px; color: #8b949e; }
</style>
</head>
<body>

<h1>MangaGrow â€” Agent æ–¹æ³•è°ƒç”¨å›¾</h1>
<p class="subtitle">Gemini API è°ƒç”¨é“¾è·¯ Â· æœåŠ¡æ–¹æ³• Â· è¾“å…¥è¾“å‡º Â· å¹¶å‘ç­–ç•¥</p>

<!-- Legend -->
<div class="legend">
  <div class="legend-item"><div class="legend-dot" style="background:#58a6ff"></div> gemini-3-flash-previewï¼ˆæ–‡æœ¬æ¨¡å‹ï¼‰</div>
  <div class="legend-item"><div class="legend-dot" style="background:#a371f7"></div> gemini-3-pro-image-previewï¼ˆå›¾åƒæ¨¡å‹ï¼‰</div>
  <div class="legend-item"><div class="legend-dot" style="background:#3fb950"></div> å¹¶è¡Œæ‰§è¡Œ</div>
  <div class="legend-item"><div class="legend-dot" style="background:#e3b341"></div> é™çº§ / Fallback</div>
</div>

<!-- Tabs -->
<div class="tabs">
  <button class="tab-btn active" onclick="switchTab('story')">æ•…äº‹ç”Ÿæˆç®¡çº¿</button>
  <button class="tab-btn" onclick="switchTab('character')">äººç‰©åˆ›å»ºç®¡çº¿</button>
  <button class="tab-btn" onclick="switchTab('input')">è¾“å…¥åˆ†æ</button>
  <button class="tab-btn" onclick="switchTab('image')">åˆ†é•œå›¾ç”Ÿæˆ</button>
  <button class="tab-btn" onclick="switchTab('routes')">API è·¯ç”±æ€»è§ˆ</button>
</div>

<!-- ==================== æ•…äº‹ç”Ÿæˆç®¡çº¿ ==================== -->
<div id="tab-story" class="diagram active">
  <div class="pipeline-container">

    <div class="flow-banner story">
      <div class="banner-icon">ğŸ“–</div>
      <div class="banner-info">
        <div class="banner-title">æ•…äº‹ç”Ÿæˆç®¡çº¿ Â· storyPipeline.ts</div>
        <div class="banner-sub">4 æ­¥ä¸²è¡Œ AI æ¨ç† + ç¬¬ 4 æ­¥ä¸æ ‡é¢˜ç”Ÿæˆå¹¶è¡Œ Â· æ¯æ­¥å« JSON Retryï¼ˆæœ€å¤š 4 æ¬¡ï¼‰</div>
      </div>
      <div class="banner-entry">å…¥å£ï¼šgenerateStory(input)</div>
    </div>

    <!-- Input -->
    <div class="step-box" style="border-color:#388bfd; background:rgba(56,139,253,0.05);">
      <div class="step-num" style="color:#58a6ff">INPUT</div>
      <div class="fn-name" style="color:#58a6ff">StoryInput</div>
      <div class="fn-desc">ç”¨æˆ·è¾“å…¥èšåˆå¯¹è±¡</div>
      <div class="io-row">
        <div class="io-chip"><span class="io-label">å­—æ®µ</span> textï¼ˆæ–‡å­—æè¿°ï¼‰</div>
        <div class="io-chip"><span class="io-label">å­—æ®µ</span> imageAnalysis[]ï¼ˆå›¾ç‰‡åˆ†æç»“æœï¼‰</div>
        <div class="io-chip"><span class="io-label">å­—æ®µ</span> characters[]ï¼ˆäººç‰©æ¡£æ¡ˆï¼‰</div>
        <div class="io-chip"><span class="io-label">å­—æ®µ</span> styleï¼ˆæ¼«ç”»é£æ ¼ï¼‰</div>
        <div class="io-chip"><span class="io-label">å­—æ®µ</span> imageCountï¼ˆåˆ†é•œæ•°çº¦æŸï¼‰</div>
      </div>
    </div>

    <div class="arrow-down">
      <svg width="2" height="32" viewBox="0 0 2 32"><line x1="1" y1="0" x2="1" y2="32" stroke="#58a6ff" stroke-width="1.5" stroke-dasharray="4,3"/></svg>
      <svg width="10" height="6" viewBox="0 0 10 6" style="position:absolute;top:26px;left:50%;transform:translateX(-50%)"><polygon points="0,0 10,0 5,6" fill="#58a6ff" opacity="0.5"/></svg>
    </div>

    <!-- Step 1 -->
    <div class="step-box" onclick="showTooltip(event,'generateOutline')" id="box-step1">
      <div class="step-num" style="color:#58a6ff">Step 1</div>
      <div class="fn-name" style="color:#58a6ff">generateOutline(input)</div>
      <div class="fn-desc">åˆ†ææ ¸å¿ƒäº‹ä»¶ï¼Œç”Ÿæˆæ¼«ç”»æ•…äº‹å¤§çº²ï¼ˆèµ·æ‰¿è½¬åˆ + æƒ…æ„Ÿå¼§çº¿ï¼‰<br>âš ï¸ äººç‰©è§„åˆ™ä¸¤æ¡£ï¼šè¢«æåŠè§’è‰²å¼ºåˆ¶å‡ºç° / æœªæåŠè§’è‰²æŒ‰éœ€</div>
      <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">
        <span class="model-badge badge-text">ğŸ”µ gemini-3-flash-preview</span>
        <span class="model-badge badge-retry">â†© JSON Retry Ã— 4</span>
        <span class="model-badge" style="background:rgba(248,200,97,0.08);border:1px solid rgba(248,200,97,0.25);color:#e3b341">systemInstruction: STORY_SYSTEM_PROMPT</span>
      </div>
      <div class="io-row">
        <div class="io-chip"><span class="io-label">OUT</span> scenes[] { beat, description, emotion }</div>
        <div class="io-chip"><span class="io-label">OUT</span> arcï¼ˆæƒ…æ„Ÿå¼§çº¿æè¿°ï¼‰</div>
      </div>
    </div>

    <div class="arrow-down">
      <svg width="2" height="32" viewBox="0 0 2 32"><line x1="1" y1="0" x2="1" y2="32" stroke="#58a6ff" stroke-width="1.5"/></svg>
      <svg width="10" height="6" viewBox="0 0 10 6" style="position:absolute;top:26px;left:50%;transform:translateX(-50%)"><polygon points="0,0 10,0 5,6" fill="#58a6ff" opacity="0.6"/></svg>
    </div>

    <!-- Step 2 -->
    <div class="step-box" onclick="showTooltip(event,'reviewOutline')" id="box-step2">
      <div class="step-num" style="color:#e3b341">Step 2</div>
      <div class="fn-name" style="color:#e3b341">reviewOutline(outline)</div>
      <div class="fn-desc">æ¼«ç”»ç¼–å‰§æ€»ç›‘è§†è§’ï¼Œå®¡æ ¸å¤§çº²å™äº‹æ¨åŠ¨åŠ›ã€å› æœè¿æ¥ã€æƒ…æ„Ÿå¼§çº¿ã€æ•…äº‹å®Œæ•´æ€§</div>
      <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">
        <span class="model-badge badge-text">ğŸ”µ gemini-3-flash-preview</span>
        <span class="model-badge badge-retry">â†© JSON Retry Ã— 4</span>
        <span class="model-badge" style="background:rgba(248,200,97,0.08);border:1px solid rgba(248,200,97,0.25);color:#e3b341">âš  å¤±è´¥æ—¶é™çº§ï¼ˆä¸é˜»æ–­ä¸»æµç¨‹ï¼‰</span>
      </div>
      <div class="io-row">
        <div class="io-chip"><span class="io-label">OUT</span> passed: boolean</div>
        <div class="io-chip"><span class="io-label">OUT</span> issues[]</div>
        <div class="io-chip"><span class="io-label">OUT</span> suggestions[]</div>
      </div>
      <div class="decision-note">
        <span>âš¡</span>
        <span>passed=false â†’ issues + suggestions é€ä¼ ç»™ Step 3 ä½œä¸ºä¿®å¤æŒ‡å¼•ï¼›ä¸é‡è·‘å¤§çº²ï¼Œç›´æ¥è¿› Step 3</span>
      </div>
    </div>

    <div class="arrow-down">
      <svg width="2" height="32" viewBox="0 0 2 32"><line x1="1" y1="0" x2="1" y2="32" stroke="#58a6ff" stroke-width="1.5"/></svg>
      <svg width="10" height="6" viewBox="0 0 10 6" style="position:absolute;top:26px;left:50%;transform:translateX(-50%)"><polygon points="0,0 10,0 5,6" fill="#58a6ff" opacity="0.6"/></svg>
    </div>

    <!-- Step 3 -->
    <div class="step-box" onclick="showTooltip(event,'detailScripts')" id="box-step3">
      <div class="step-num" style="color:#58a6ff">Step 3</div>
      <div class="fn-name" style="color:#58a6ff">detailScripts(outline, input, reviewIssues?)</div>
      <div class="fn-desc">ç»†åŒ–æ¯æ ¼åˆ†é•œè„šæœ¬ï¼šdescriptionï¼ˆ50-100å­—ç”»é¢æè¿°ï¼‰+ captionï¼ˆ30-50å­—å™è¿°ï¼‰+ emotionalBeat<br>åŒæ­¥æå– keyObjects å’Œ characterDefinitions ç”¨äºåç»­å›¾ç‰‡ç”Ÿæˆ</div>
      <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">
        <span class="model-badge badge-text">ğŸ”µ gemini-3-flash-preview</span>
        <span class="model-badge badge-retry">â†© JSON Retry Ã— 4</span>
        <span class="model-badge" style="background:rgba(248,200,97,0.08);border:1px solid rgba(248,200,97,0.25);color:#e3b341">systemInstruction: STORY_SYSTEM_PROMPT</span>
      </div>
      <div class="io-row">
        <div class="io-chip"><span class="io-label">OUT</span> scripts[] { sceneNumber, description, caption, emotionalBeat }</div>
        <div class="io-chip"><span class="io-label">OUT</span> keyObjects[] { name, description }</div>
        <div class="io-chip"><span class="io-label">OUT</span> characterDefinitions[] { name, description }</div>
      </div>
    </div>

    <div class="arrow-down" style="padding:10px 0">
      <svg width="2" height="36" viewBox="0 0 2 36"><line x1="1" y1="0" x2="1" y2="36" stroke="#58a6ff" stroke-width="1.5"/></svg>
      <svg width="10" height="6" viewBox="0 0 10 6" style="position:absolute;top:30px;left:50%;transform:translateX(-50%)"><polygon points="0,0 10,0 5,6" fill="#58a6ff" opacity="0.6"/></svg>
    </div>

    <!-- Step 4 + Title â€” Parallel -->
    <div style="margin-bottom:6px;font-size:11px;color:#3fb950;font-weight:700;text-align:center;letter-spacing:1px">âš¡ PARALLEL EXECUTION â€” Promise.all()</div>
    <div class="parallel-group">
      <div class="step-box" onclick="showTooltip(event,'checkConsistency')" id="box-step4a" style="border-color:rgba(56,189,141,0.35)">
        <div class="step-num" style="color:#3fb950">Step 4a</div>
        <div class="fn-name" style="color:#3fb950">checkConsistency(scripts, charDefs)</div>
        <div class="fn-desc">æ£€æŸ¥åˆ†é•œé—´è§’è‰²æè¿°ã€åœºæ™¯è¿è´¯ã€æ—¶é—´çº¿ã€ç‰©å“ä¸€è‡´æ€§ï¼›æœ‰é—®é¢˜è‡ªåŠ¨ä¿®æ­£ description</div>
        <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">
          <span class="model-badge badge-text">ğŸ”µ gemini-3-flash-preview</span>
          <span class="model-badge badge-retry">â†© JSON Retry Ã— 4</span>
        </div>
        <div class="io-row">
          <div class="io-chip"><span class="io-label">OUT</span> scripts[]ï¼ˆå·²ä¿®æ­£ï¼‰</div>
          <div class="io-chip"><span class="io-label">OUT</span> passed: boolean</div>
        </div>
      </div>

      <div class="parallel-separator"><span>â€–</span></div>

      <div class="step-box" onclick="showTooltip(event,'generateTitle')" id="box-step4b" style="border-color:rgba(56,189,141,0.35)">
        <div class="step-num" style="color:#3fb950">Step 4b</div>
        <div class="fn-name" style="color:#3fb950">generateTitleInternal(text, imageAnalysis?)</div>
        <div class="fn-desc">ç”Ÿæˆ 4-10 å­—æ•…äº‹æ ‡é¢˜ï¼šã€Œ{äººå}+{æ ¸å¿ƒäº‹ä»¶}ã€æ ¼å¼ï¼Œç¦æ­¢æƒ…ç»ªè¯å¼€å¤´</div>
        <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">
          <span class="model-badge badge-text">ğŸ”µ gemini-3-flash-preview</span>
          <span class="model-badge" style="background:rgba(248,200,97,0.08);border:1px solid rgba(248,200,97,0.25);color:#e3b341">Fallback â†’ text.slice(0,10)</span>
        </div>
        <div class="io-row">
          <div class="io-chip"><span class="io-label">OUT</span> title: stringï¼ˆ4-10å­—ï¼‰</div>
        </div>
      </div>
    </div>

    <div class="arrow-down" style="padding:10px 0">
      <svg width="2" height="32" viewBox="0 0 2 32"><line x1="1" y1="0" x2="1" y2="32" stroke="#3fb950" stroke-width="1.5"/></svg>
      <svg width="10" height="6" viewBox="0 0 10 6" style="position:absolute;top:26px;left:50%;transform:translateX(-50%)"><polygon points="0,0 10,0 5,6" fill="#3fb950" opacity="0.6"/></svg>
    </div>

    <!-- Output -->
    <div class="step-box" style="border-color:rgba(56,189,141,0.4);background:rgba(56,189,141,0.04);">
      <div class="step-num" style="color:#3fb950">OUTPUT</div>
      <div class="fn-name" style="color:#3fb950">StoryOutput</div>
      <div class="fn-desc">æ•…äº‹ç”Ÿæˆå®Œæˆï¼Œè¿”å›ç»“æ„åŒ–æ•°æ®ä¾›å‰ç«¯å±•ç¤º</div>
      <div class="io-row">
        <div class="io-chip"><span class="io-label">å­—æ®µ</span> title</div>
        <div class="io-chip"><span class="io-label">å­—æ®µ</span> currentBatch[]ï¼ˆSceneScriptï¼‰</div>
        <div class="io-chip"><span class="io-label">å­—æ®µ</span> totalScenes</div>
        <div class="io-chip"><span class="io-label">å­—æ®µ</span> keyObjects[]</div>
        <div class="io-chip"><span class="io-label">å­—æ®µ</span> characterDefinitions[]</div>
        <div class="io-chip"><span class="io-label">å­—æ®µ</span> storyOutline</div>
      </div>
    </div>

    <!-- Year Summary -->
    <div style="margin-top:40px;margin-bottom:12px;" class="section-label">å¹´åº¦æ€»ç»“æ¨¡å¼ï¼ˆç‹¬ç«‹è°ƒç”¨ï¼‰</div>
    <div class="step-box" onclick="showTooltip(event,'yearlySummary')">
      <div class="step-num" style="color:#58a6ff">Export</div>
      <div class="fn-name" style="color:#58a6ff">generateYearlySummary(stories[])</div>
      <div class="fn-desc">æ ¹æ®å¤šä¸ª {title, inputText} ç”Ÿæˆ 300-500 å­—æ¸©é¦¨æˆé•¿æ€»ç»“ï¼Œç»“å°¾å«å¯¹å­©å­æœªæ¥çš„æœŸè®¸</div>
      <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">
        <span class="model-badge badge-text">ğŸ”µ gemini-3-flash-preview</span>
        <span class="model-badge badge-retry">â†© withRetry Ã— 3</span>
        <span class="model-badge" style="background:rgba(248,200,97,0.08);border:1px solid rgba(248,200,97,0.25);color:#e3b341">æŠ›å‡ºå¼‚å¸¸ â†’ è·¯ç”±å±‚é™çº§</span>
      </div>
      <div class="io-row">
        <div class="io-chip"><span class="io-label">IN</span> SummaryStoryItem[] { title, inputText }</div>
        <div class="io-chip"><span class="io-label">OUT</span> summary: string</div>
      </div>
    </div>

  </div>
</div>

<!-- ==================== äººç‰©åˆ›å»ºç®¡çº¿ ==================== -->
<div id="tab-character" class="diagram">
  <div class="pipeline-container">

    <div class="flow-banner char">
      <div class="banner-icon">ğŸ­</div>
      <div class="banner-info">
        <div class="banner-title">äººç‰©åˆ›å»ºç®¡çº¿ Â· characterAnalyzer.ts</div>
        <div class="banner-sub">3 æ­¥ä¸²è¡Œï¼šå¤–è²Œåˆ†æ â†’ Qç‰ˆå¤´åƒç”Ÿæˆ â†’ æ€§åˆ«å¹´é¾„è¯†åˆ«</div>
      </div>
      <div class="banner-entry">å…¥å£ï¼šcreateCharacterFull(name, imageData, mimeType)</div>
    </div>

    <!-- Input -->
    <div class="step-box" style="border-color:rgba(163,113,247,0.4);background:rgba(163,113,247,0.04);">
      <div class="step-num" style="color:#a371f7">INPUT</div>
      <div class="fn-name" style="color:#a371f7">ç…§ç‰‡è¾“å…¥</div>
      <div class="fn-desc">å®¶é•¿ä¸Šä¼ çš„å­©å­ç…§ç‰‡</div>
      <div class="io-row">
        <div class="io-chip"><span class="io-label">å­—æ®µ</span> nameï¼ˆäººç‰©åå­—ï¼‰</div>
        <div class="io-chip"><span class="io-label">å­—æ®µ</span> imageDataï¼ˆbase64ï¼‰</div>
        <div class="io-chip"><span class="io-label">å­—æ®µ</span> mimeType</div>
      </div>
    </div>

    <div class="arrow-down"><svg width="2" height="32" viewBox="0 0 2 32"><line x1="1" y1="0" x2="1" y2="32" stroke="#a371f7" stroke-width="1.5"/></svg><svg width="10" height="6" viewBox="0 0 10 6" style="position:absolute;top:26px;left:50%;transform:translateX(-50%)"><polygon points="0,0 10,0 5,6" fill="#a371f7" opacity="0.6"/></svg></div>

    <!-- Step 1 -->
    <div class="step-box">
      <div class="step-num" style="color:#a371f7">Step 1</div>
      <div class="fn-name" style="color:#a371f7">analyzeCharacter(name, imageData, mimeType)</div>
      <div class="fn-desc">åˆ†æç…§ç‰‡ï¼Œç”Ÿæˆ 150-200 å­—è¶…è¯¦ç»†è§†è§‰æè¿°ï¼šå¤´å‘ã€é»˜è®¤æœè£…ï¼ˆå›ºå®šï¼‰ã€é¢éƒ¨ç‰¹å¾ã€é…é¥°ã€ä½“å‹ã€‚ç”¨äºä¿è¯å¤šç”»é¢äººç‰©ä¸€è‡´æ€§ã€‚</div>
      <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">
        <span class="model-badge badge-text">ğŸ”µ gemini-3-flash-preview</span>
        <span class="model-badge badge-retry">â†© withRetry Ã— 3</span>
        <span class="model-badge" style="background:rgba(248,200,97,0.08);border:1px solid rgba(248,200,97,0.25);color:#e3b341">å¤±è´¥ â†’ é™çº§ fallback æè¿°</span>
      </div>
      <div class="io-row">
        <div class="io-chip"><span class="io-label">IN</span> ç…§ç‰‡ inlineData + åˆ†ææŒ‡ä»¤</div>
        <div class="io-chip"><span class="io-label">OUT</span> description: stringï¼ˆ150-200å­—ï¼‰</div>
      </div>
    </div>

    <div class="arrow-down"><svg width="2" height="32" viewBox="0 0 2 32"><line x1="1" y1="0" x2="1" y2="32" stroke="#a371f7" stroke-width="1.5"/></svg><svg width="10" height="6" viewBox="0 0 10 6" style="position:absolute;top:26px;left:50%;transform:translateX(-50%)"><polygon points="0,0 10,0 5,6" fill="#a371f7" opacity="0.6"/></svg></div>

    <!-- Step 2 -->
    <div class="step-box">
      <div class="step-num" style="color:#a371f7">Step 2</div>
      <div class="fn-name" style="color:#a371f7">generateAvatar(name, imageData, mimeType, description, gender?, ageGroup?)</div>
      <div class="fn-desc">åŸºäºç…§ç‰‡ + description ç”Ÿæˆ Qç‰ˆå¡é€šå¤´åƒï¼ˆå¤´èº«æ¯” 2:1~3:1ï¼Œå¤§çœ¼èŒç³»ï¼‰<br>ä¼˜å…ˆçº§ï¼šå‚è€ƒå›¾è¯†åˆ«åº¦ &gt; å¯çˆ±åº¦ &gt; é£æ ¼åŒ–ã€‚2K åˆ†è¾¨ç‡ï¼Œ1:1 å®«æ ¼ã€‚</div>
      <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">
        <span class="model-badge badge-image">ğŸŸ£ gemini-3-pro-image-preview</span>
        <span class="model-badge badge-retry">â†© withRetry Ã— 3</span>
        <span class="model-badge" style="background:rgba(248,200,97,0.08);border:1px solid rgba(248,200,97,0.25);color:#e3b341">aspectRatio: 1:1 Â· imageSize: 2K</span>
      </div>
      <div class="io-row">
        <div class="io-chip"><span class="io-label">IN</span> ç…§ç‰‡ inlineData + description + ç”ŸæˆæŒ‡ä»¤</div>
        <div class="io-chip"><span class="io-label">OUT</span> { data: base64, mimeType } â†’ saveImage('avatars')</div>
      </div>
    </div>

    <div class="arrow-down"><svg width="2" height="32" viewBox="0 0 2 32"><line x1="1" y1="0" x2="1" y2="32" stroke="#a371f7" stroke-width="1.5"/></svg><svg width="10" height="6" viewBox="0 0 10 6" style="position:absolute;top:26px;left:50%;transform:translateX(-50%)"><polygon points="0,0 10,0 5,6" fill="#a371f7" opacity="0.6"/></svg></div>

    <!-- Step 3 -->
    <div class="step-box">
      <div class="step-num" style="color:#a371f7">Step 3</div>
      <div class="fn-name" style="color:#a371f7">detectGenderAge(imageData, mimeType)</div>
      <div class="fn-desc">ä»ç…§ç‰‡è¯†åˆ«ï¼šæ€§åˆ«ï¼ˆç”·/å¥³/æœªçŸ¥ï¼‰ã€å¹´é¾„æ®µï¼ˆå©´å„¿/å¹¼å„¿/å„¿ç«¥/å°‘å„¿/æˆäºº/æœªçŸ¥ï¼‰</div>
      <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">
        <span class="model-badge badge-text">ğŸ”µ gemini-3-flash-preview</span>
        <span class="model-badge badge-retry">â†© withRetry Ã— 3</span>
        <span class="model-badge" style="background:rgba(248,200,97,0.08);border:1px solid rgba(248,200,97,0.25);color:#e3b341">å¤±è´¥ â†’ é»˜è®¤"æœªçŸ¥"</span>
      </div>
      <div class="io-row">
        <div class="io-chip"><span class="io-label">OUT</span> gender: string</div>
        <div class="io-chip"><span class="io-label">OUT</span> ageGroup: string</div>
      </div>
    </div>

    <div class="arrow-down"><svg width="2" height="32" viewBox="0 0 2 32"><line x1="1" y1="0" x2="1" y2="32" stroke="#a371f7" stroke-width="1.5"/></svg><svg width="10" height="6" viewBox="0 0 10 6" style="position:absolute;top:26px;left:50%;transform:translateX(-50%)"><polygon points="0,0 10,0 5,6" fill="#a371f7" opacity="0.6"/></svg></div>

    <!-- Output -->
    <div class="step-box" style="border-color:rgba(163,113,247,0.4);background:rgba(163,113,247,0.04);">
      <div class="step-num" style="color:#a371f7">OUTPUT</div>
      <div class="fn-name" style="color:#a371f7">CharacterAnalysisResult</div>
      <div class="fn-desc">äººç‰©æ¡£æ¡ˆåˆ›å»ºå®Œæˆï¼Œå­˜å…¥ DB</div>
      <div class="io-row">
        <div class="io-chip"><span class="io-label">å­—æ®µ</span> description</div>
        <div class="io-chip"><span class="io-label">å­—æ®µ</span> avatarData + avatarMimeType</div>
        <div class="io-chip"><span class="io-label">å­—æ®µ</span> gender</div>
        <div class="io-chip"><span class="io-label">å­—æ®µ</span> ageGroup</div>
      </div>
    </div>

    <!-- Standalone export -->
    <div style="margin-top:40px;margin-bottom:12px;" class="section-label">ç‹¬ç«‹å¯¼å‡ºæ–¹æ³•</div>
    <div class="parallel-group">
      <div class="step-box">
        <div class="step-num" style="color:#a371f7">Export</div>
        <div class="fn-name" style="color:#a371f7">analyzeCharacter(name, img, mime)</div>
        <div class="fn-desc">å•ç‹¬è°ƒç”¨äººç‰©åˆ†æï¼ˆAPI è·¯ç”± analyze-character ä½¿ç”¨ï¼‰</div>
        <div class="io-row"><div class="io-chip"><span class="io-label">OUT</span> description: string</div></div>
      </div>
      <div class="parallel-separator"><span>Â·</span></div>
      <div class="step-box">
        <div class="step-num" style="color:#a371f7">Export</div>
        <div class="fn-name" style="color:#a371f7">detectGenderAge(img, mime)</div>
        <div class="fn-desc">å•ç‹¬è°ƒç”¨æ€§åˆ«å¹´é¾„æ£€æµ‹ï¼ˆAPI è·¯ç”± detect-gender-age ä½¿ç”¨ï¼‰</div>
        <div class="io-row"><div class="io-chip"><span class="io-label">OUT</span> { gender, ageGroup }</div></div>
      </div>
      <div class="parallel-separator"><span>Â·</span></div>
      <div class="step-box">
        <div class="step-num" style="color:#a371f7">Export</div>
        <div class="fn-name" style="color:#a371f7">generateAvatar(name, img, mime, desc, ...)</div>
        <div class="fn-desc">å•ç‹¬è°ƒç”¨å¤´åƒé‡ç”Ÿæˆï¼ˆAPI è·¯ç”± generate-avatar ä½¿ç”¨ï¼Œå¯æ›´æ–° DBï¼‰</div>
        <div class="io-row"><div class="io-chip"><span class="io-label">OUT</span> { data, mimeType }</div></div>
      </div>
    </div>

  </div>
</div>

<!-- ==================== è¾“å…¥åˆ†æ ==================== -->
<div id="tab-input" class="diagram">
  <div class="pipeline-container">

    <div class="flow-banner input">
      <div class="banner-icon">ğŸ™ï¸</div>
      <div class="banner-info">
        <div class="banner-title">è¾“å…¥åˆ†ææœåŠ¡ Â· inputAnalyzer.ts</div>
        <div class="banner-sub">éŸ³é¢‘è½¬å†™ + å›¾ç‰‡å¹¶è¡Œåˆ†æï¼Œä¸ºæ•…äº‹ç®¡çº¿æä¾›ç»“æ„åŒ–è¾“å…¥</div>
      </div>
      <div class="banner-entry">å¯¼å‡ºï¼štranscribeAudio Â· analyzeImages</div>
    </div>

    <!-- Audio -->
    <div class="section-label">è¯­éŸ³è½¬å†™</div>
    <div class="step-box">
      <div class="step-num" style="color:#3fb950">Export</div>
      <div class="fn-name" style="color:#3fb950">transcribeAudio(audioBase64, mimeType)</div>
      <div class="fn-desc">å°†å®¶é•¿çš„è¯­éŸ³æè¿°è½¬å½•ä¸ºæ–‡å­—ï¼Œä¿ç•™å£è¯­åŒ–é£æ ¼</div>
      <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">
        <span class="model-badge badge-text">ğŸ”µ gemini-3-flash-preview</span>
        <span class="model-badge badge-retry">â†© withRetry Ã— 3</span>
      </div>
      <div class="io-row">
        <div class="io-chip"><span class="io-label">IN</span> audio inlineData { mimeType: 'audio/webm', data }</div>
        <div class="io-chip"><span class="io-label">IN</span> è½¬å½•æŒ‡ä»¤æ–‡æœ¬</div>
        <div class="io-chip"><span class="io-label">OUT</span> text: stringï¼ˆè½¬å½•æ–‡å­—ï¼‰</div>
      </div>
    </div>

    <div style="height:32px"></div>

    <!-- Image analyze -->
    <div class="section-label">å›¾ç‰‡å¹¶è¡Œåˆ†æ</div>
    <div class="step-box">
      <div class="step-num" style="color:#3fb950">Export</div>
      <div class="fn-name" style="color:#3fb950">analyzeImages(imageBase64s[])</div>
      <div class="fn-desc">å¯¹æ¯å¼ å›¾ç‰‡å¹¶è¡Œè°ƒç”¨ Geminiï¼Œæå–ï¼šåœºæ™¯ã€äººç‰©åŠ¨ä½œã€å…³é”®ç‰©å“ã€æƒ…ç»ªæ°›å›´<br>å•å›¾å¤±è´¥ä¸å½±å“æ•´ä½“ï¼Œè¿”å› fallback æè¿°</div>
      <div style="display:flex;align-items:center;gap:6px">
        <span class="model-badge badge-text">ğŸ”µ gemini-3-flash-preview</span>
        <span class="model-badge badge-retry">â†© withRetry Ã— 4ï¼ˆæ¯å›¾ç‹¬ç«‹ï¼‰</span>
        <span class="model-badge" style="background:rgba(56,189,141,0.1);border:1px solid rgba(56,189,141,0.3);color:#3fb950">Promise.all å¹¶è¡Œ</span>
      </div>
      <div class="io-row">
        <div class="io-chip"><span class="io-label">IN</span> Array&lt;{ data: base64, mimeType }&gt;</div>
        <div class="io-chip"><span class="io-label">OUT</span> ImageAnalysis[] { index, description } â€”â€” æŒ‰ index æ’åº</div>
      </div>
    </div>

    <!-- Parallel diagram -->
    <div style="margin:24px 0 12px;text-align:center;font-size:11px;color:#3fb950;font-weight:700">âš¡ å¤šå›¾å¹¶è¡Œç¤ºæ„ï¼ˆ3å¼ å›¾ä¸ºä¾‹ï¼‰</div>
    <div class="parallel-group">
      <div class="step-box" style="border-color:rgba(56,189,141,0.3)">
        <div class="fn-name" style="color:#3fb950;font-size:12px">analyzeOne(img[0], 0)</div>
        <div class="fn-desc" style="font-size:11px">å›¾1 â†’ Gemini â†’ description</div>
      </div>
      <div class="parallel-separator"><span>â€–</span></div>
      <div class="step-box" style="border-color:rgba(56,189,141,0.3)">
        <div class="fn-name" style="color:#3fb950;font-size:12px">analyzeOne(img[1], 1)</div>
        <div class="fn-desc" style="font-size:11px">å›¾2 â†’ Gemini â†’ description</div>
      </div>
      <div class="parallel-separator"><span>â€–</span></div>
      <div class="step-box" style="border-color:rgba(56,189,141,0.3)">
        <div class="fn-name" style="color:#3fb950;font-size:12px">analyzeOne(img[2], 2)</div>
        <div class="fn-desc" style="font-size:11px">å›¾3 â†’ Gemini â†’ description</div>
      </div>
    </div>

    <div class="arrow-down" style="padding:10px 0"><svg width="2" height="32" viewBox="0 0 2 32"><line x1="1" y1="0" x2="1" y2="32" stroke="#3fb950" stroke-width="1.5"/></svg><svg width="10" height="6" viewBox="0 0 10 6" style="position:absolute;top:26px;left:50%;transform:translateX(-50%)"><polygon points="0,0 10,0 5,6" fill="#3fb950" opacity="0.6"/></svg></div>

    <div class="step-box" style="border-color:rgba(56,189,141,0.4);background:rgba(56,189,141,0.04);">
      <div class="fn-name" style="color:#3fb950">åˆå¹¶ + æ’åº â†’ ImageAnalysis[]</div>
      <div class="fn-desc">sort by indexï¼Œé€ä¼ ç»™æ•…äº‹ç®¡çº¿ Step 1 generateOutline çš„ imageAnalysis å­—æ®µ</div>
    </div>

  </div>
</div>

<!-- ==================== åˆ†é•œå›¾ç”Ÿæˆ ==================== -->
<div id="tab-image" class="diagram">
  <div class="pipeline-container">

    <div class="flow-banner img">
      <div class="banner-icon">ğŸ¨</div>
      <div class="banner-info">
        <div class="banner-title">åˆ†é•œå›¾ç”Ÿæˆ Â· imageGenerator.ts</div>
        <div class="banner-sub">6å±‚ä¼˜å…ˆçº§æç¤ºè¯ Â· äººç‰©å‚è€ƒå›¾æ³¨å…¥ Â· è§†è§‰å¼•ç”¨å¤±è´¥è‡ªåŠ¨é™çº§ä¸ºçº¯æ–‡æœ¬</div>
      </div>
      <div class="banner-entry">å…¥å£ï¼šgenerateSceneImage(params)</div>
    </div>

    <!-- Input -->
    <div class="step-box" style="border-color:rgba(248,200,97,0.4);background:rgba(248,200,97,0.04);">
      <div class="step-num" style="color:#e3b341">INPUT</div>
      <div class="fn-name" style="color:#e3b341">SceneGenerationParams</div>
      <div class="io-row">
        <div class="io-chip"><span class="io-label">å­—æ®µ</span> scriptï¼ˆåˆ†é•œ descriptionï¼Œ50-100å­—ï¼‰</div>
        <div class="io-chip"><span class="io-label">å­—æ®µ</span> styleï¼ˆæ¼«ç”»é£æ ¼ï¼‰</div>
        <div class="io-chip"><span class="io-label">å­—æ®µ</span> ratioï¼ˆå®½é«˜æ¯”ï¼‰</div>
        <div class="io-chip"><span class="io-label">å­—æ®µ</span> characterContext</div>
        <div class="io-chip"><span class="io-label">å­—æ®µ</span> objectContext</div>
        <div class="io-chip"><span class="io-label">å­—æ®µ</span> referenceChars[]ï¼ˆCharacterImageRefï¼‰</div>
        <div class="io-chip"><span class="io-label">å­—æ®µ</span> sceneReferenceImages[]</div>
        <div class="io-chip"><span class="io-label">å­—æ®µ</span> isUserPhoto?</div>
      </div>
    </div>

    <div class="arrow-down"><svg width="2" height="32" viewBox="0 0 2 32"><line x1="1" y1="0" x2="1" y2="32" stroke="#e3b341" stroke-width="1.5"/></svg><svg width="10" height="6" viewBox="0 0 10 6" style="position:absolute;top:26px;left:50%;transform:translateX(-50%)"><polygon points="0,0 10,0 5,6" fill="#e3b341" opacity="0.6"/></svg></div>

    <!-- Prompt assembly -->
    <div class="step-box">
      <div class="step-num" style="color:#e3b341">Prompt</div>
      <div class="fn-name" style="color:#e3b341">6å±‚ä¼˜å…ˆçº§æç¤ºè¯ç»„è£…</div>
      <div class="fn-desc">å›¾åƒæç¤ºè¯æŒ‰ä¼˜å…ˆçº§åˆ†å±‚æ„å»ºï¼Œæ¯å±‚è¦†ç›–ä¸‹å±‚</div>
      <div style="margin-top:12px;display:flex;flex-direction:column;gap:6px">
        <div class="io-chip" style="justify-content:flex-start"><span style="min-width:24px;font-weight:700;color:#e3b341">â‘ </span> ä¸¥æ ¼ä¸€è‡´æ€§è§„åˆ™ï¼ˆCRITICALï¼‰â€” å‚è€ƒå›¾ä¼˜å…ˆäºæ–‡å­—æè¿°</div>
        <div class="io-chip" style="justify-content:flex-start"><span style="min-width:24px;font-weight:700;color:#e3b341">â‘¡</span> äººç‰©å®šä¹‰ï¼ˆcharacterContext â€” åå­— + è§†è§‰ç‰¹å¾ï¼‰</div>
        <div class="io-chip" style="justify-content:flex-start"><span style="min-width:24px;font-weight:700;color:#e3b341">â‘¢</span> ç”»é¢æè¿°ï¼ˆscript â€” 50-100å­—åˆ†é•œè„šæœ¬ï¼‰</div>
        <div class="io-chip" style="justify-content:flex-start"><span style="min-width:24px;font-weight:700;color:#e3b341">â‘£</span> å…³é”®ç‰©å“å®šä¹‰ï¼ˆobjectContextï¼‰</div>
        <div class="io-chip" style="justify-content:flex-start"><span style="min-width:24px;font-weight:700;color:#e3b341">â‘¤</span> é£æ ¼å‚æ•°ï¼ˆgetStylePrompt â€” è‹±æ–‡é£æ ¼å…³é”®è¯ï¼‰</div>
        <div class="io-chip" style="justify-content:flex-start"><span style="min-width:24px;font-weight:700;color:#e3b341">â‘¥</span> è´¨é‡è¦æ±‚ï¼ˆæ¸©é¦¨/å¯çˆ±/æ²»æ„ˆï¼Œç¦æ­¢å¤šæ ¼/æ°´å°/å¤šä½™æ‰‹æŒ‡ï¼‰</div>
      </div>
    </div>

    <div class="arrow-down"><svg width="2" height="32" viewBox="0 0 2 32"><line x1="1" y1="0" x2="1" y2="32" stroke="#e3b341" stroke-width="1.5"/></svg><svg width="10" height="6" viewBox="0 0 10 6" style="position:absolute;top:26px;left:50%;transform:translateX(-50%)"><polygon points="0,0 10,0 5,6" fill="#e3b341" opacity="0.6"/></svg></div>

    <!-- Visual ref injection -->
    <div class="step-box">
      <div class="step-num" style="color:#e3b341">Parts</div>
      <div class="fn-name" style="color:#e3b341">è§†è§‰å‚è€ƒæ³¨å…¥ç­–ç•¥</div>
      <div class="fn-desc">æŒ‰ç…§äººç‰©+åœºæ™¯æ³¨å…¥ï¼Œæ¯å¼ å‚è€ƒå›¾ç´§è·Ÿå…¶æ ‡ç­¾æ–‡æœ¬ï¼ˆinterleavedï¼‰</div>
      <div style="margin-top:12px;display:flex;flex-direction:column;gap:6px">
        <div class="io-chip" style="justify-content:flex-start"><span style="min-width:80px;font-weight:700;color:#e3b341">åœºæ™¯å‚è€ƒå¸§</span> sceneReferenceImages[0] + æ ‡ç­¾ï¼ˆé£æ ¼å‚è€ƒ or ç”¨æˆ·ç…§ç‰‡ï¼‰</div>
        <div class="io-chip" style="justify-content:flex-start"><span style="min-width:80px;font-weight:700;color:#e3b341">äººç‰©å‚è€ƒ</span> Qç‰ˆå¤´åƒ inlineData + ã€Œ[äººç‰© X çš„Qç‰ˆå½¢è±¡]ã€æ ‡ç­¾</div>
        <div class="io-chip" style="justify-content:flex-start"><span style="min-width:80px;font-weight:700;color:#e3b341">å¤šè§’åº¦è¡¨</span> referenceSheetï¼ˆå¦‚æœ‰ï¼‰+ æ ‡ç­¾</div>
        <div class="io-chip" style="justify-content:flex-start"><span style="min-width:80px;font-weight:700;color:#e3b341">ä¸»æç¤ºè¯</span> basePromptTextï¼ˆæœ€åæ³¨å…¥ï¼‰</div>
      </div>
    </div>

    <div class="arrow-down"><svg width="2" height="32" viewBox="0 0 2 32"><line x1="1" y1="0" x2="1" y2="32" stroke="#e3b341" stroke-width="1.5"/></svg><svg width="10" height="6" viewBox="0 0 10 6" style="position:absolute;top:26px;left:50%;transform:translateX(-50%)"><polygon points="0,0 10,0 5,6" fill="#e3b341" opacity="0.6"/></svg></div>

    <!-- Execution -->
    <div class="step-box">
      <div class="step-num" style="color:#e3b341">Gen</div>
      <div class="fn-name" style="color:#e3b341">executeGeneration(hasVisuals)</div>
      <div class="fn-desc">è°ƒç”¨ Gemini å›¾åƒæ¨¡å‹ï¼ŒimageSize: 1K</div>
      <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">
        <span class="model-badge badge-image">ğŸŸ£ gemini-3-pro-image-preview</span>
        <span class="model-badge badge-retry">â†© withRetry Ã— 3</span>
      </div>
      <div class="decision-note">
        <span>ğŸ›¡ï¸</span>
        <span>æœ‰å‚è€ƒå›¾å¤±è´¥ â†’ è‡ªåŠ¨ Fallback åˆ°çº¯æ–‡æœ¬æ¨¡å¼ï¼ˆhasVisuals=falseï¼‰å†é‡è¯•ä¸€æ¬¡</span>
      </div>
      <div class="io-row" style="margin-top:10px">
        <div class="io-chip"><span class="io-label">OUT</span> { data: base64, mimeType } â†’ saveImage('scenes')</div>
        <div class="io-chip"><span class="io-label">RES</span> imageUrl: /api/images/scenes/xxx.png</div>
      </div>
    </div>

  </div>
</div>

<!-- ==================== API è·¯ç”±æ€»è§ˆ ==================== -->
<div id="tab-routes" class="diagram">
  <div class="route-section">

    <div class="flow-banner" style="border-color:rgba(139,148,158,0.3);background:rgba(139,148,158,0.04);margin-bottom:28px">
      <div class="banner-icon">ğŸŒ</div>
      <div class="banner-info">
        <div class="banner-title">REST API è·¯ç”±æ€»è§ˆ Â· server/routes/ai.ts</div>
        <div class="banner-sub">æ‰€æœ‰è·¯ç”±æŒ‚è½½åœ¨ /api/ai/ Â· Express Router Â· ç«¯å£ 3001</div>
      </div>
    </div>

    <table class="route-table">
      <thead>
        <tr>
          <th style="width:180px">ç«¯ç‚¹</th>
          <th style="width:90px">è°ƒç”¨æœåŠ¡</th>
          <th>è¾“å…¥</th>
          <th>è¾“å‡º</th>
          <th style="width:100px">AI æ¨¡å‹</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>
            <span class="method-post">POST</span><br>
            <span class="route-path">/api/ai/transcribe-audio</span>
          </td>
          <td><span class="service-tag tag-input">inputAnalyzer</span></td>
          <td><code style="font-size:11px">{ audioBase64, mimeType }</code></td>
          <td><code style="font-size:11px">{ text: string }</code></td>
          <td><span class="model-badge badge-text" style="font-size:10px">Flash</span></td>
        </tr>
        <tr>
          <td>
            <span class="method-post">POST</span><br>
            <span class="route-path">/api/ai/analyze-images</span>
          </td>
          <td><span class="service-tag tag-input">inputAnalyzer</span></td>
          <td><code style="font-size:11px">{ images: [{data, mimeType}] }</code></td>
          <td><code style="font-size:11px">ImageAnalysis[]</code></td>
          <td><span class="model-badge badge-text" style="font-size:10px">Flash Ã—N</span></td>
        </tr>
        <tr>
          <td>
            <span class="method-post">POST</span><br>
            <span class="route-path">/api/ai/generate-story</span>
          </td>
          <td><span class="service-tag tag-story">storyPipeline</span></td>
          <td><code style="font-size:11px">StoryInput</code></td>
          <td><code style="font-size:11px">StoryOutput</code></td>
          <td><span class="model-badge badge-text" style="font-size:10px">Flash Ã—4</span></td>
        </tr>
        <tr>
          <td>
            <span class="method-post">POST</span><br>
            <span class="route-path">/api/ai/generate-image</span>
          </td>
          <td><span class="service-tag tag-image">imageGenerator</span><br><span class="service-tag" style="font-size:10px;background:rgba(139,148,158,0.12);color:#8b949e">DBæŸ¥è§’è‰²å¼•ç”¨å›¾</span></td>
          <td><code style="font-size:11px">{ script, style, ratio, referenceCharIds[], sceneReferenceImages[], ... }</code></td>
          <td><code style="font-size:11px">{ imageUrl: string }</code></td>
          <td><span class="model-badge badge-image" style="font-size:10px">Pro Image</span></td>
        </tr>
        <tr>
          <td>
            <span class="method-post">POST</span><br>
            <span class="route-path">/api/ai/analyze-character</span>
          </td>
          <td><span class="service-tag tag-char">characterAnalyzer</span></td>
          <td><code style="font-size:11px">{ name, imageData, mimeType }</code></td>
          <td><code style="font-size:11px">{ description: string }</code></td>
          <td><span class="model-badge badge-text" style="font-size:10px">Flash</span></td>
        </tr>
        <tr>
          <td>
            <span class="method-post">POST</span><br>
            <span class="route-path">/api/ai/generate-avatar</span>
          </td>
          <td><span class="service-tag tag-char">characterAnalyzer</span><br><span class="service-tag" style="font-size:10px;background:rgba(139,148,158,0.12);color:#8b949e">saveImage + DBæ›´æ–°</span></td>
          <td><code style="font-size:11px">{ name, imageData, mimeType, description, gender?, ageGroup?, specificAge?, characterId? }</code></td>
          <td><code style="font-size:11px">{ avatarUrl: string }</code></td>
          <td><span class="model-badge badge-image" style="font-size:10px">Pro Image</span></td>
        </tr>
        <tr>
          <td>
            <span class="method-post">POST</span><br>
            <span class="route-path">/api/ai/detect-gender-age</span>
          </td>
          <td><span class="service-tag tag-char">characterAnalyzer</span></td>
          <td><code style="font-size:11px">{ imageData, mimeType }</code></td>
          <td><code style="font-size:11px">{ gender, ageGroup }</code></td>
          <td><span class="model-badge badge-text" style="font-size:10px">Flash</span></td>
        </tr>
        <tr>
          <td>
            <span class="method-post">POST</span><br>
            <span class="route-path">/api/ai/generate-summary</span>
          </td>
          <td><span class="service-tag tag-story">storyPipeline</span></td>
          <td><code style="font-size:11px">{ stories: SummaryStoryItem[] }</code></td>
          <td><code style="font-size:11px">{ summary: string }</code></td>
          <td><span class="model-badge badge-text" style="font-size:10px">Flash</span></td>
        </tr>
      </tbody>
    </table>

    <!-- withRetry detail -->
    <div style="margin-top:32px">
      <div class="section-label" style="margin-bottom:16px">é€šç”¨é‡è¯•æœºåˆ¶ Â· gemini.ts â†’ withRetry()</div>
      <div class="step-box">
        <div class="fn-name" style="color:#8b949e">withRetry&lt;T&gt;(operation, retries=3)</div>
        <div class="fn-desc">æŒ‡æ•°é€€é¿ + æŠ–åŠ¨ï¼šbaseDelay = 1000ms Ã— 2^i + random(0~1000ms)<br>4xx é”™è¯¯ä¸é‡è¯•ï¼ˆ429 é™¤å¤–ï¼‰Â· å…¨éƒ¨å¤±è´¥æ—¶æŠ›å‡ºæœ€åä¸€æ¬¡å¼‚å¸¸</div>
        <div class="io-row">
          <div class="io-chip"><span class="io-label">Retry 1</span> ~1-2s</div>
          <div class="io-chip"><span class="io-label">Retry 2</span> ~2-3s</div>
          <div class="io-chip"><span class="io-label">Retry 3</span> ~4-5s</div>
        </div>
        <div class="decision-note" style="margin-top:10px">
          <span>ğŸ“</span>
          <span>storyPipeline çš„ callAiWithJsonRetry åœ¨æ­¤åŸºç¡€ä¸Šé¢å¤–å¢åŠ  JSON è§£æé‡è¯•ï¼ˆæœ€å¤š4æ¬¡ï¼‰ï¼Œé—´éš” 2s Ã— 2^attempt</span>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Tooltip -->
<div id="tooltip" class="tooltip"></div>

<script>
// Tab switch
function switchTab(name) {
  document.querySelectorAll('.diagram').forEach(d => d.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-' + name).classList.add('active');
  event.target.classList.add('active');
  hideTooltip();
}

// Tooltip data
const tooltips = {
  generateOutline: {
    title: 'generateOutline(input)',
    model: 'ğŸ”µ gemini-3-flash-preview Â· JSON',
    rows: [
      ['System Prompt', 'STORY_SYSTEM_PROMPTï¼ˆå„¿ç«¥æˆé•¿æ¼«ç”»åˆ›ä½œåŠ©æ‰‹ï¼‰'],
      ['äººç‰©è§„åˆ™', 'è¢«æåŠè§’è‰²å¼ºåˆ¶å‡ºç° / æœªæåŠè§’è‰²å¯é€‰'],
      ['åˆ†é•œæ•°çº¦æŸ', 'imageCount>0 â†’ å›ºå®šæ•°é‡ï¼›å¦åˆ™ 2-4 æ ¼'],
      ['è¾“å‡ºæ ¼å¼', '{ scenes[{beat,description,emotion}], arc }'],
      ['Retry', 'JSON Retry Ã— 4 + æŒ‡æ•°é€€é¿'],
    ]
  },
  reviewOutline: {
    title: 'reviewOutline(outline)',
    model: 'ğŸ”µ gemini-3-flash-preview Â· JSON',
    rows: [
      ['å®¡æ ¸ç»´åº¦', 'å™äº‹æ¨åŠ¨åŠ› / å› æœè¿æ¥ / æƒ…æ„Ÿå¼§çº¿ / æ•…äº‹å®Œæ•´æ€§'],
      ['å¤±è´¥ç­–ç•¥', 'ä¸é‡è·‘å¤§çº²ï¼Œissues é€ä¼ ç»™ Step 3'],
      ['é™çº§è¯´æ˜', 'å¤±è´¥æ—¶ç»§ç»­è¿› Step 3ï¼ˆä¸é˜»æ–­ä¸»æµç¨‹ï¼‰'],
    ]
  },
  detailScripts: {
    title: 'detailScripts(outline, input, reviewIssues?)',
    model: 'ğŸ”µ gemini-3-flash-preview Â· JSON',
    rows: [
      ['description', '50-100å­—ç”»é¢æè¿°ï¼Œç”¨äºå›¾ç‰‡ç”Ÿæˆ'],
      ['caption', '30-50å­—æ•…äº‹å™è¿°ï¼Œå±•ç¤ºåœ¨åˆ†é•œå›¾ä¸‹æ–¹'],
      ['emotionalBeat', 'æƒ…æ„ŸèŠ‚æ‹æ ‡æ³¨'],
      ['keyObjects', 'å…³é”®ç‰©å“æå–'],
      ['characterDefs', 'è§’è‰²è§†è§‰å®šä¹‰ï¼ˆè·¨é•œå¤´ä¸€è‡´æ€§åŸºç¡€ï¼‰'],
    ]
  },
  checkConsistency: {
    title: 'checkConsistency(scripts, charDefs)',
    model: 'ğŸ”µ gemini-3-flash-preview Â· JSON',
    rows: [
      ['æ£€æŸ¥ç»´åº¦', 'è§’è‰²ä¸€è‡´æ€§ / åœºæ™¯è¿è´¯ / æ—¶é—´çº¿ / ç‰©å“'],
      ['è‡ªåŠ¨ä¿®æ­£', 'æœ‰ fix â†’ ç›´æ¥æ›¿æ¢ descriptionï¼Œä¸å†é‡è·‘'],
      ['å¹¶è¡Œ', 'ä¸ generateTitleInternal åŒæ—¶æ‰§è¡Œ'],
    ]
  },
  generateTitle: {
    title: 'generateTitleInternal(text, imageAnalysis?)',
    model: 'ğŸ”µ gemini-3-flash-preview Â· text/plain',
    rows: [
      ['æ ¼å¼è¦æ±‚', '4-10å­—ï¼Œã€Œ{äººå}+{æ ¸å¿ƒäº‹ä»¶}ã€ä¼˜å…ˆ'],
      ['ç¦æ­¢', 'æƒ…ç»ªè¯å¼€å¤´ / å½¢å®¹è¯å †å '],
      ['Fallback', 'å¤±è´¥ â†’ text.slice(0,10) + "..."'],
      ['å¹¶è¡Œ', 'ä¸ checkConsistency åŒæ—¶æ‰§è¡Œ'],
    ]
  },
  yearlySummary: {
    title: 'generateYearlySummary(stories[])',
    model: 'ğŸ”µ gemini-3-flash-preview Â· text/plain',
    rows: [
      ['è¾“å…¥', 'SummaryStoryItem[] { title, inputText }'],
      ['è¾“å‡º', '300-500å­—è¿è´¯æˆé•¿æ€»ç»“æ®µè½'],
      ['é”™è¯¯å¤„ç†', 'æŠ›å‡ºå¼‚å¸¸ â†’ è·¯ç”±å±‚è¿”å› { success: false }ï¼Œå‰ç«¯é™çº§'],
    ]
  }
};

function showTooltip(e, key) {
  const data = tooltips[key];
  if (!data) return;
  const tt = document.getElementById('tooltip');
  let html = `<div class="tt-title">${data.title}</div>`;
  html += `<div class="tt-model" style="color:#8b949e;font-size:11px;margin-bottom:8px">${data.model}</div>`;
  data.rows.forEach(([k, v]) => {
    html += `<div class="tt-row"><strong>${k}ï¼š</strong>${v}</div>`;
  });
  tt.innerHTML = html;
  tt.style.display = 'block';
  positionTooltip(e);
}

function positionTooltip(e) {
  const tt = document.getElementById('tooltip');
  const x = e.clientX + 16;
  const y = e.clientY + 8;
  const maxX = window.innerWidth - 320;
  const maxY = window.innerHeight - 200;
  tt.style.left = Math.min(x, maxX) + 'px';
  tt.style.top = Math.min(y, maxY) + 'px';
}

function hideTooltip() {
  document.getElementById('tooltip').style.display = 'none';
}

document.addEventListener('mousemove', (e) => {
  const tt = document.getElementById('tooltip');
  if (tt.style.display === 'block') positionTooltip(e);
});

document.addEventListener('click', (e) => {
  if (!e.target.closest('.step-box')) hideTooltip();
});
</script>
</body>
</html>
