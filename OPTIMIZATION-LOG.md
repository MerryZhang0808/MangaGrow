# 技术优化记录

本文档记录代码实现层面的优化，不涉及产品需求变更。

---

## [优化 1] - 2026-02-06

### 优化目标
**解决人物一致性问题**：多个分镜中人物的发型、衣服颜色、物品外观会变化。

### 问题分析
- AI 图像生成模型在人物一致性方面存在固有限制
- 原有提示词不够强，缺乏明确的"禁止改变"指令
- 人物描述不够详细，缺少固定服装、精确颜色等关键信息

### 实施的优化

#### 1. 强化图像生成提示词
**文件**：`comic-growth-record/services/geminiService.ts`
**位置**：第 334-365 行（generateImage 函数）
**改动**：
- 将简单的"一致性规则"扩展为详细的 5 点规则
- 明确禁止项：禁止改变发型、禁止改变服装颜色、禁止改变款式
- 强调优先级：一致性 > 美观度 > 创意性

**改进前**：
```
[严格一致性规则]
1. 外貌一致性：必须严格按照定义绘制人物
2. 颜色锁定：必须使用定义中指定的确切颜色
3. 命名匹配：将脚本中的人物名字与定义对应
```

**改进后**：
```
[严格一致性规则 - CRITICAL]
⚠️ 以下规则是强制性的，违反会导致生成失败：

1. 发型绝对固定：
   - 人物的发型、发色、发长必须与定义完全一致
   - 禁止改变发型样式、刘海、发饰
   - 如果定义中是短发，绝不能画成长发

2. 服装颜色锁定：
   - 必须使用定义中明确指定的颜色
   - 例如：蓝色就是蓝色，不能变成紫色或深蓝
   - 禁止自由发挥或调整色调

3. 服装款式固定：
   - 必须与定义中的服装类型一致（T恤、连衣裙、外套等）
   - 禁止更换服装类型
   - 细节（领口、袖子、图案）必须保持一致

4. 面部特征一致：
   - 眼睛形状、大小、颜色必须一致
   - 眉毛、鼻子、嘴巴的风格必须一致
   - 如有眼镜、发卡等配饰，必须始终存在

5. 物品一致性：
   - 如果物品定义中指定了颜色、形状，必须严格遵守
   - 同一物品在不同分镜中必须保持相同外观

⚠️ 优先级：一致性 > 美观度 > 创意性
```

#### 2. 优化人物描述生成
**文件**：`comic-growth-record/services/geminiService.ts`
**位置**：第 443-467 行（generateCharacter 函数）
**改动**：
- 生成人物描述时要求更详细（150-200字 vs 之前的50字）
- 明确要求定义"默认服装"（固定的衣服）
- 要求精确颜色名称（"天蓝色"而不是"蓝色"）
- 增加发型细节（刘海样式、发饰位置等）
- 增加体型、年龄段等辅助信息

**改进前**：
```
关注点：
1. 头发：确切的发型、颜色和长度
2. 服装：定义服装类型、定义每件物品的确切颜色
3. 脸部：眼睛形状、眼镜（如有）、显著特征
```

**改进后**：
```
必须包含以下所有细节：

1. 头发（必须非常具体）：
   - 发型名称（短发/长发/中长发/马尾/双马尾/披肩发等）
   - 确切的发色（不要只说"棕色"，要说"浅棕色"、"深棕色"或"栗色"）
   - 刘海样式（齐刘海/斜刘海/中分/无刘海）
   - 发饰（如有发卡、发带、蝴蝶结，必须说明颜色和位置）

2. 默认服装（这是固定的，不能改变）：
   - 上衣类型：（T恤/衬衫/连衣裙/毛衣等）
   - 上衣颜色：精确颜色名称（如"天蓝色"、"粉红色"、"柠檬黄"）
   - 上衣特征：（圆领/V领/有图案/纯色/条纹等）
   - 下装类型：（牛仔裤/短裙/长裤等）
   - 下装颜色：精确颜色名称
   - 特殊说明：这是该人物的标准服装，在所有场景中默认穿着

3. 面部特征：
   - 眼睛：大小、形状、颜色
   - 眉毛：粗细、形状
   - 脸型：圆脸/瓜子脸/方脸
   - 特殊标记：痣、酒窝、雀斑等

4. 配饰（如有）：眼镜、首饰、其他

5. 体型特征：年龄段、身高、体型
```

**示例输出格式**：
```
"念念，女孩，4岁幼儿。【发型】齐肩短发，浅棕色，齐刘海，左侧别着红色小发卡。
【默认服装-固定】上衣为天蓝色短袖T恤，圆领，胸前有白色小兔子图案；下装为深蓝色牛仔短裤。
【面部】大眼睛，黑色瞳孔，粗眉毛，圆脸，左脸颊有一个小酒窝。
【体型】标准身材，身高偏矮。【特征】笑起来露出两颗小虎牙。"
```

### 预期效果
- **一致性提升**：预计提升 50%
- **用户体验**：减少需要重新生成的次数
- **副作用**：人物创建时间可能略微增加（因为描述更详细）

#### 3. 添加连续性参考（前一张图作为参考）
**文件**：
- `comic-growth-record/App.tsx`（第 159-202 行）
- `comic-growth-record/components/DisplayPanel.tsx`（第 74-105 行）
- `comic-growth-record/services/geminiService.ts`（第 356-383 行）

**改动**：
在生成第 2、3、4 个分镜时，自动将**前一个分镜的生成结果**作为参考图传递给 AI。

**实现逻辑**：

1. **App.tsx - 主生成流程**：
   - 添加变量 `previousGeneratedImage` 追踪上一张生成的图片
   - 生成每个分镜后，保存其 URL 供下一个分镜使用
   - 优先级：用户上传的照片 > 前一张生成的图 > 无参考

   ```typescript
   let previousGeneratedImage: string | null = null;

   for (let i = 0; i < initialScenes.length; i++) {
     // 如果用户没上传这个分镜的照片，且不是第一个分镜
     if (i > 0 && previousGeneratedImage && specificInputImage.length === 0) {
       continuityReference.push(previousGeneratedImage);
     }

     const imageUrl = await generateImage(..., referenceImages);
     previousGeneratedImage = imageUrl; // 保存供下一个分镜使用
   }
   ```

2. **DisplayPanel.tsx - 重新生成流程**：
   - 用户点击"重绘"按钮时，也使用前一个分镜作为参考
   - 查找前一个分镜：`scenes.find(s => s.sceneNumber === current - 1)`
   - 如果找到且有图片，传递给生成函数

3. **geminiService.ts - 区分参考图类型**：
   - 检测参考图是否为 base64 数据（`startsWith('data:image')`）
   - 如果是生成的图片（连续性参考），给出专门的提示词：
     ```
     ⚠️ 连续性要求：
     - 人物的【发型、发色、刘海】必须与参考图完全一致
     - 人物的【服装颜色、服装类型、服装细节】必须与参考图完全一致
     - 人物的【面部特征】必须与参考图完全一致
     - 只改变：人物的【动作、姿态、表情】和【场景背景】
     ```
   - 如果是用户上传的照片，给出不同的指令（转绘为目标风格）

**工作原理示例**：
```
用户生成 4 个分镜的故事：
- 分镜 1：无参考（首个分镜）
- 分镜 2：参考分镜 1 的生成结果 ✨
- 分镜 3：参考分镜 2 的生成结果 ✨
- 分镜 4：参考分镜 3 的生成结果 ✨
```

**优势**：
- AI 可以"看到"前一个画面的具体样子
- 明确知道发型、服装颜色的准确样式
- 即使文字描述有歧义，视觉参考也能确保一致性

**预期效果**：
- 一致性再提升 25%
- 特别对连续动作的故事效果明显
- 结合前两项优化，总提升约 75%

---

### 后续改进建议
1. **物品库系统**：类似人物库，为常见物品创建固定外观定义
2. **多次生成并筛选**：自动生成多个版本，使用 AI 评估一致性后选择最佳
3. **种子锁定**：研究是否可以通过固定随机种子进一步提升一致性

---

## 使用建议

为了最大化这些优化的效果，建议用户：

1. **重新创建人物**
   - 删除旧的人物（旧系统生成的描述不够详细）
   - 用新系统重新创建人物

2. **创建人物时的最佳实践**
   - 上传**同一套衣服**的多张照片（正面、侧面、全身）
   - 选择希望固定的服装样式

3. **生成漫画时的技巧**
   - 在脚本中可以强调："穿着和之前一样的蓝色T恤"
   - 描述物品时指定颜色："红色的玩具小汽车"

4. **不满意时**
   - 点击"重绘"按钮多生成几次
   - 选择最一致的那张

---

## 技术说明

### 为什么不在 Product Spec 中记录？
- Product Spec 描述的是**产品需求**（What），不是实现细节（How）
- 这些优化是**实现质量提升**，不改变产品功能
- 用户使用流程、UI 布局、功能列表都没有变化

### 为什么不在 Changelog 中记录？
- `Product-Spec-CHANGELOG.md` 记录的是**需求文档的变更**
- 这次是代码优化，不是需求变更

### 如何追踪这些优化？
- 使用本文档（OPTIMIZATION-LOG.md）记录技术优化
- 使用 Git commit 记录代码变更
- 如果未来这些优化成为产品特性（如"物品库系统"），再更新 Product Spec

---

## 相关文件

- `comic-growth-record/services/geminiService.ts` - AI 服务实现
- `Product-Spec.md` - 产品需求文档（未变更）
- `Product-Spec-CHANGELOG.md` - 需求文档变更记录（未变更）
