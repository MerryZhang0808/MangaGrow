# 变更记录

## [v1.4] - 2026-02-14
### 新增
- **故事标题**：AI 根据故事内容自动生成简短标题（5-15字），用户可点击编辑修改
- **自动保存**：漫画生成完成后自动保存到历史记录，修改分镜（编辑脚本、重绘图片、修改标题）后自动同步更新到后端
- **历史记录侧边栏**：左侧导航栏新增「历史记录」图标，点击打开侧边栏，按时间倒序显示已保存的漫画故事（标题 + 日期 + 缩略图 + 分镜数），支持删除
- **历史故事加载**：点击历史记录卡片，右侧面板加载该故事分镜（与生成结果展示结构完全一致），支持重绘、编辑、导出等所有操作
- **网格海报导出**：新增「导出海报」选项，将所有分镜拼合为网格海报 PNG（标题 + 日期 + 2列自适应分镜网格 + MangaGrow 水印），白色背景
- **海报分镜排版规则**：固定 2 列，奇数末行居中，支持 2-8 张分镜自适应
- **右侧面板顶部信息栏**：生成完成后显示故事标题（可编辑）、创建时间、自动保存状态指示
- **AI 功能 - 故事标题生成**：新增 AI 功能提示词，根据故事内容生成简短温馨标题
- **stories 表 title 字段**：数据库新增 `title TEXT` 列存储故事标题
- **stories 表 updated_at 字段**：新增 `updated_at INTEGER` 列追踪修改时间
- **PUT /api/stories/:id 端点**：新增故事更新 API（标题修改、分镜同步）

### 修改
- **导出按钮**：从单一「导出」按钮改为下拉按钮（「导出海报」+「导出 ZIP」）
- **导出流程**：移除导出时保存逻辑（已改为生成后自动保存），简化为选择导出方式 → 下载
- **导航栏中部图标**：新增历史记录图标（人物库 → 历史记录 → 新创作）
- **输入区标题**：「新的回忆」在生成后由 AI 替换为故事标题，可点击编辑
- **第二期规划**：新增「更多海报导出格式」（竖版长图、故事海报）

---

## [v1.3] - 2026-02-10
### 新增
- **后端架构**：新增 Node.js/Express 轻量后端层，端口 3001，Vite 通过 proxy 转发 `/api/*`
- **SQLite 数据库**：使用 better-sqlite3，存储人物库（characters 表）、漫画历史（stories 表 + scenes 表）
- **本地文件存储**：图片存储到 `data/images/` 目录（avatars/ + scenes/），前端通过 URL 访问
- **AI 代理路由**：所有 Gemini API 调用通过 `/api/ai/*` 后端端点代理，API Key 不再暴露给前端
- **人物库 REST API**：`GET/POST/PUT/DELETE /api/characters`，完整 CRUD
- **漫画历史 REST API**：`GET/POST/DELETE /api/stories`，含分镜数据
- **图片静态服务**：`GET /api/images/:type/:filename`
- **多用户预留**：所有数据库表包含 `user_id` 字段（当前为 NULL），为第二期用户系统做准备
- **后端项目结构**：`server/` 目录（routes/、db/、services/）

### 修改
- **数据持久化方式**：从浏览器 LocalStorage 改为后端 SQLite + 本地磁盘
- **API Key 配置**：从前端 `VITE_GEMINI_API_KEY`（暴露在客户端）改为服务端 `.env` 中的 `GEMINI_API_KEY`
- **前端 AI 调用**：从直连 Gemini API 改为通过后端 `/api/ai/*` 代理
- **图片传输**：从 base64 Data URL（内存中）改为服务端文件 URL
- **启动方式**：从单独启动 Vite 改为 concurrently 同时启动前后端
- **第二期规划**：「用户登录系统和云端保存」调整为「用户认证与云端部署」（后端已预留 user_id）
- **AI 系统提示词 [总体规则]**：更新数据保存方式描述，新增 AI 代理说明

### 删除
- **前端 Gemini 直连**：不再从前端直接调用 Gemini API
- **LocalStorage 依赖**：不再使用浏览器本地存储保存人物库和历史数据
- **VITE_GEMINI_API_KEY 环境变量**：前端不再需要 API Key

---

## [v1.2] - 2026-02-10
### 新增
- **性别年龄识别**：创建人物时，AI 自动识别照片中人物的性别和年龄段（1-3秒）
- **人物详情页**：点击人物库列表中的小卡片，进入详情页查看大图并编辑信息
- **性别字段**：下拉框选择（男/女/未知），默认值为 AI 识别结果
- **年龄段字段**：下拉框选择（婴儿/幼儿/儿童/少儿/成人/未知），默认值为 AI 识别结果
- **具体年龄字段**：文本框（可选），用户可填写精确年龄（如"1.5岁"）
- **头像重新生成**：详情页中，用户修改性别/年龄后，点击图片右上角刷新按钮手动重新生成头像
- **年龄一致性保证**：用户确认的性别/年龄信息写入 character.description，用于后续漫画生成时保持人物年龄一致（如头像1.5岁，漫画也是1.5岁，不会变成3-4岁）

### 修改
- **人物卡片信息**：小卡片新增性别和年龄标识（文字标签）
- **人物卡片交互**：从不可点击改为可点击，点击进入详情页
- **头像生成比例**：统一使用 1:1 方形比例（2K分辨率），取消"先生成大图后变小图"的流程
- **创建人物流程**：上传照片 → 生成头像 → AI 识别性别/年龄 → 自动保存到列表 → 点击卡片可进入详情页编辑
- **AI 功能提示词**：新增"人物性别年龄识别"功能提示词；更新"人物卡通化生成"提示词，融合性别/年龄参数

### 解决的问题
- **年龄不一致问题**：之前创建的1.5岁人物头像准确，但后续生成的漫画中人物看起来像3-4岁。现在通过性别/年龄字段明确标注并写入 character.description，确保漫画生成时 AI 有明确的年龄约束。

---

## [v1.1] - 2026-02-06
### 修改
- **整体布局**：从三栏布局（左30% + 中15% + 右55%）改为左侧导航栏（固定64px） + 中间输入区（400px） + 右侧展示区（flex）
- **导航栏**：新增左侧窄栏导航，包含产品图标、人物库图标、新创作图标
- **输入区结构**：原「左侧输入区」改名为「中间输入区」，宽度固定为 400px
- **设置区位置**：从独立的「中间选项设置区」改为集成在输入区底部，支持折叠/展开
- **设置触发方式**：从独立栏位改为底部操作栏左侧的「设置」图标按钮触发
- **分镜卡片布局**：从横向布局（左30%脚本 + 右70%图片）改为纵向布局（上70%图片 + 下30%脚本）
- **分镜卡片样式**：采用漫画边框风格（黑色粗边框 + 阴影），编号显示为左上角黑底白字标签
- **操作按钮交互**：原「重新生成」按钮固定显示改为鼠标悬停时显示「重绘」和「编辑脚本」按钮
- **底部操作栏**：从多个独立按钮改为右下角浮动操作栏（「重绘全部」+「导出」）
- **UI 文案**：
  - 欢迎提示：「在左侧输入故事，我会帮你生成漫画分镜！」→「等待你的故事...」
  - 页面标题：「漫画成长记录」→「新的回忆」（New Memory）
  - 按钮文案：「下一步」→ 删除；「开始生成」→「生成漫画」（Generate Comic）
  - 人物库按钮：「创建新人物」→「新建人物」（New Character）
  - 操作按钮：「重新生成」→「重绘」（Redraw）；新增「编辑脚本」（Edit Script）
  - 脚本编辑确认：新增「保存并重绘」（Save & Redraw）按钮
- **导出流程**：从弹出选项（PNG/JPG、单张/打包）改为自动打包 ZIP 文件下载
- **用户流程描述**：更新所有流程步骤以匹配新布局
- **AI 系统提示词**：更新 [图片生成阶段] 中的布局描述，从「左30%脚本 + 右70%图片」改为「上70%图片 + 下30%脚本」

---

## [v1.0] - 2026-02-06
- 初始版本
