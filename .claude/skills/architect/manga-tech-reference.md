# 漫画领域技术方案参考

本文档包含 MangaGrow 项目可能用到的漫画生成技术方案。
architect skill 在做技术选型时参考本文档，选择最适合的方案。

---

## 1. 人物一致性（Character Consistency）

### 问题定义
AI 生成的角色图像在不同分镜间外观会"漂移"——发型、服装、体型等特征不一致。
仅靠文字提示词描述角色特征，一致性约 40-60%，无法达到产品级质量。

### 方案 A：角色参考表 + 多参考图注入（推荐）

**原理**：创建角色时先生成标准化的角色参考表（多角度/多表情），
后续每次生成分镜图时将参考表图片作为视觉锚点注入 API 调用。

**实现方式**：
1. 创建角色时：用户上传照片 → AI 生成角色参考表（正面/侧面/全身，中性姿势和背景）
2. 参考表存入角色档案：图片（base64）+ 结构化视觉特征描述（JSON）
3. 生成分镜时：自动将角色参考表图片作为 Gemini API 的 inlineData 传入
4. 提示词中用完整的视觉特征描述引用角色（不允许只写名字）

**Gemini API 约束**：
- 最多支持 14 张参考图（包括角色 + 风格参考）
- 建议每个角色传入 2 张参考图（正面 + 全身）
- 如果分镜涉及 3 个角色，共传入 6 张参考图，留 8 张给风格参考

**质量标准**：
- 角色面部特征识别度：同一角色在不同分镜中应保持可识别
- 服装一致性：除非剧情需要换装，服装应完全一致
- 检查方法：生成后用 AI 对比参考表和生成图的角色特征相似度

**已验证经验**（来自项目开发记录）：
- 图片分辨率必须 2K（2048x2048），1K 不够清晰
- 同时传入照片 + 文字描述效果远好于只传文字
- 提示词中优先级：识别度 > 可爱度 > 风格化

### 方案 B：纯提示词描述（备选/降级方案）

**原理**：每次生成时在提示词中重复角色的完整视觉描述。

**适用场景**：API 参考图数量不够时的降级方案。

**效果**：一致性约 40-60%，适合对一致性要求不高的场景。

---

## 2. 故事生成管线（Story Pipeline）

### 问题定义
单次 API 调用生成剧本，故事质量不稳定——可能出现逻辑断裂、缺乏情感弧线、
分镜之间缺乏因果关系、存在纯装饰性废镜头。

### 推荐方案：多步骤管线 + 质量关卡

**管线设计**：

```
Step 1: 输入分析
  输入 → 用户文字/语音/照片
  输出 → 结构化事件（谁、做了什么、情感、关键细节）
  模型 → gemini-flash（快速）

Step 2: 故事大纲生成
  输入 → 结构化事件
  输出 → 故事大纲（起-承-转-合 结构，情感弧线标注）
  模型 → gemini-flash
  约束 → 必须有情感弧线，不允许全平铺

Step 3: 大纲质量审核（质量关卡 1）
  输入 → 故事大纲
  输出 → 审核结果（通过/不通过 + 修改建议）
  审核维度：
    - 每个分镜是否推动叙事？（不允许纯装饰镜头）
    - 前后分镜是否有因果或时间连接？
    - 整组分镜是否有情感起伏？
    - 对话是否口语化、符合角色特征？
  不通过 → 带修改建议回到 Step 2 重新生成（最多 2 次）

Step 4: 分镜脚本细化
  输入 → 审核通过的大纲 + 角色档案
  输出 → 逐个分镜的详细脚本（画面描述 + 角色动作 + 对话 + 镜头语言）
  约束 → 每个分镜的画面描述必须包含角色完整视觉特征

Step 5: 脚本一致性检查（质量关卡 2）
  输入 → 全部分镜脚本
  输出 → 一致性检查结果
  检查维度：
    - 角色描述是否前后一致？
    - 场景描述是否连贯？
    - 时间线是否合理？
  不通过 → 标记不一致项，局部修正
```

**质量标准**：
- 故事完整性：必须有起承转合，不允许戛然而止
- 分镜效率：每个分镜必须推动叙事，0 废镜头
- 情感弧线：至少有一个情感高点
- 检查方法：Step 3 和 Step 5 的自动审核

---

## 3. 风格一致性（Style Consistency）

### 问题定义
同一组分镜中，不同图片的风格可能不一致——色调、笔触、光影风格跳变。

### 推荐方案：风格锁定 + 全局参数

**实现方式**：
1. 用户选择风格后，锁定一组风格参数（不只是风格名称）
2. 每个风格对应一组详细的视觉描述提示词
3. 每次生成图片时，风格提示词自动注入（不允许生成时漏掉）

**四种风格的详细参数**：

| 风格名称 | 提示词关键词 |
|---------|-------------|
| 温馨卡通 | soft lighting, warm color palette, rounded features, gentle expressions, pastel background, children's book illustration style, cozy atmosphere |
| 柔和水彩 | watercolor technique, soft edges, muted tones, flowing colors, gentle gradients, hand-painted feel, dreamy atmosphere, light wash effect |
| 简约扁平 | flat design, clean lines, bold solid colors, minimal shadows, geometric shapes, modern illustration, simple background, vector art style |
| 手绘涂鸦 | hand-drawn sketch, pencil texture, loose lines, playful doodle style, casual strokes, notebook paper feel, spontaneous and fun |

**约束**：
- 同一组分镜必须使用完全相同的风格参数
- 风格参数存储在全局状态中，不允许分镜间修改
- 生成提示词时必须包含完整的风格参数（不允许只写风格名称）

---

## 4. 图片生成质量优化

### 已验证的最佳实践

**分辨率**：
- 必须使用 2K（2048x2048）
- 1K 细节不足，用户感知明显

**提示词结构**（优先级从高到低）：
```
1. 最高优先级约束（必须遵守的规则）
2. 角色视觉特征（详细的外观描述）
3. 场景和动作描述（具体的画面内容）
4. 风格化参数（完整的风格关键词）
5. 画面质量要求（high quality, detailed, professional）
6. 负面提示（no text, no watermark, no distortion）
```

**使用的模型**：
- 图片生成：gemini-2.0-flash-preview-image-generation（支持图文混合输入输出）
- 文本分析：gemini-2.0-flash（快速响应）

**错误处理**：
- API 调用必须有重试机制（至少 2 次）
- 重试时微调提示词（添加 "improved quality" 等增强词）
- 2 次重试后仍失败，向用户报告并提供手动调整选项

---

## 5. 视频生成（规划中）

### 技术方案概览

**Gemini API 视频能力**：
- Veo：图片转视频（静态图加动画效果）
- Prompt Based Video Generation：文本转视频

**分步生成策略**：
```
Step 1: 关键帧选择
  从分镜图中选择关键帧（每个分镜取一张）

Step 2: 动态规划
  为每个关键帧规划：
  - 镜头运动（推/拉/摇/固定）
  - 角色动作（简单动作，如转头、微笑、挥手）
  - 环境动态（风吹、光影变化）

Step 3: 逐帧生成
  使用 Veo 将静态分镜图转为短视频片段

Step 4: 拼接和过渡
  添加分镜间的过渡效果
  添加字幕/对话气泡

Step 5: 音频（可选）
  添加背景音乐
  TTS 生成旁白/对话
```

**注意**：视频生成目前为规划阶段，需要先做 POC 验证 Veo 的实际效果。

---

## 6. 语音输入处理

### 推荐方案

**实现方式**：
1. 浏览器 MediaRecorder API 录音
2. 录音完成后发送到 Gemini API 转文字
3. 转写结果插入文字输入框
4. 用户可编辑后提交

**质量标准**：
- 中文识别准确率需满足日常口语水平
- 支持方言容错（不强求完美，用户可手动修正）
- 延迟：录音结束后 3 秒内返回结果

---

*最后更新：2026-02-09*
*随着项目开发推进，本文档应持续更新已验证的技术方案和经验。*
